<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kho D∆∞·ª£c GDP - IDECO (Pro Export)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #2563eb; --secondary: #1e40af; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --light: #f1f5f9; --dark: #1e293b; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.5; color: var(--dark); background: #f8fafc; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; min-height: 90vh; display: flex; flex-direction: column; }
        
        header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 1.5rem; margin: 0; font-weight: 700; }
        
        .nav-tabs { display: flex; background: #e2e8f0; padding: 10px 10px 0; }
        .nav-tab { padding: 10px 20px; cursor: pointer; background: #cbd5e1; margin-right: 4px; border-radius: 6px 6px 0 0; font-weight: 600; color: #475569; transition: 0.2s; }
        .nav-tab.active { background: white; color: var(--primary); border-top: 3px solid var(--primary); }
        .tab-content { display: none; padding: 20px; flex: 1; }
        .tab-content.active { display: block; }

        .grid-layout { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        @media(max-width:1000px) { .grid-layout { grid-template-columns: 1fr; } }
        
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 100%; display: flex; flex-direction: column; }
        .card-header { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; }
        
        input, select, textarea { width: 100%; padding: 8px 12px; margin: 5px 0 15px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; transition: border 0.3s; }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        label { font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 2px; display: block; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; font-size: 0.85rem; }
        .btn:hover { opacity: 0.9; }
        .btn-success { background: var(--success); } .btn-primary { background: var(--primary); } .btn-danger { background: var(--danger); } .btn-warning { background: var(--warning); }
        
        .autocomplete-wrapper { position: relative; width: 100%; }
        .autocomplete-items { position: absolute; top: 100%; left: 0; right: 0; z-index: 9999; background: white; border: 1px solid #cbd5e1; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); border-radius: 0 0 6px 6px; }
        .autocomplete-item { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; display: flex; justify-content: space-between; }
        .autocomplete-item:hover { background: #eff6ff; border-left: 3px solid var(--primary); }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        th { background: #f8fafc; text-align: left; padding: 10px; font-weight: 700; border: 1px solid #e2e8f0; color: #334155; position: sticky; top: 0; z-index: 10; }
        td { padding: 4px; border: 1px solid #e2e8f0; vertical-align: top; }
        .table-input { border: 1px solid transparent; background: transparent; width: 100%; padding: 8px; margin: 0; font-size: 0.9rem; }
        .table-input:focus { border: 1px solid var(--primary); background: white; border-radius: 4px; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: 0.3s; z-index: 10000; }
        .toast.show { opacity: 1; transform: translateY(-10px); }

        .export-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .export-item:hover { border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .export-info { flex: 1; }
        .export-actions { display: flex; gap: 5px; }

        .app-footer { background: #f1f5f9; padding: 10px 20px; border-top: 1px solid #e2e8f0; font-size: 0.85rem; color: #64748b; text-align: right; font-style: italic; }

        /* Error row style */
        .row-error { background-color: #fee2e2 !important; }
        .row-error td { border-color: #fca5a5; }
    </style>
</head>
<body>
    <datalist id="master-code-list"></datalist>

    <div class="container">
        <header>
            <h1>QU·∫¢N L√ù KHO D∆Ø·ª¢C GDP - IDECO</h1>
            <button class="btn btn-warning" onclick="toggleMasterSection()">
                üìÇ D·ªØ Li·ªáu G·ªëc (Master)
            </button>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('tab1', this)">1. NH·∫¨P KHO & T·ªíN KHO</div>
            <div class="nav-tab" onclick="switchTab('tab2', this)" id="btn-tab2">2. XU·∫§T KHO & B√ÅO C√ÅO</div>
        </div>

        <div id="tab1" class="tab-content active">
            <div id="master-section" style="display:none; background:#fffbeb; padding:15px; margin-bottom:20px; border-radius:8px; border:1px solid #fbbf24;">
                <h3 style="margin-top:0; color:#92400e">D·ªØ li·ªáu Master</h3>
                <input type="file" id="master-upload" accept=".xlsx, .xls, .csv">
                <div id="master-status" style="margin-top:10px; font-weight:bold; color:#059669;"></div>
                <div id="master-files-list" style="margin-top:10px;"></div>
            </div>

            <div class="grid-layout">
                <div class="card">
                    <div class="card-header">A. Nh·∫≠p Kho Th·ªß C√¥ng</div>
                    <label>T√™n H√†ng H√≥a (*)</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="imp-name" placeholder="G√µ t√™n thu·ªëc..." autocomplete="off">
                        <div id="imp-suggest" class="autocomplete-items"></div>
                    </div>
                    <div style="display:flex; gap:10px">
                        <div style="flex:1"><label>M√£ SP</label><input type="text" id="imp-code" placeholder="T·ª± load..." style="background:#f1f5f9; font-weight:bold; color:var(--primary)"></div>
                        <div style="flex:1"><label>ƒê∆°n V·ªã</label><input type="text" id="imp-unit" placeholder="H·ªôp/Vi√™n..."></div>
                    </div>
                    <div style="display:flex; gap:10px">
                        <div style="flex:1"><label>S·ªë L√¥</label><input type="text" id="imp-lot"></div>
                        <div style="flex:1"><label>H·∫°n D√πng</label><input type="date" id="imp-exp"></div>
                    </div>
                    <div style="display:flex; gap:10px">
                        <div style="flex:1"><label>S·ªë L∆∞·ª£ng</label><input type="number" id="imp-qty"></div>
                        <div style="flex:1"><label>Ng√†y Nh·∫≠p</label><input type="date" id="imp-date"></div>
                    </div>
                    <button class="btn btn-success" style="width:100%" onclick="saveManual()">L∆ØU NH·∫¨P KHO</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        B. Nh·∫≠p H√†ng Lo·∫°t
                        <div style="float:right">
                            <button class="btn btn-primary" onclick="toggleMode('paste')">Paste</button>
                            <button class="btn btn-warning" onclick="toggleMode('file')">Excel</button>
                        </div>
                    </div>
                    <div id="mode-paste">
                        <p style="font-size:0.85rem; color:#64748b; margin-bottom:5px">C·ªôt: <b>STT | T√™n | ƒê∆°n V·ªã | L√¥ | H·∫°n | SL</b></p>
                        <textarea id="paste-area" style="height:80px; width:100%; border:2px dashed #ccc; background:#f9f9f9"></textarea>
                        <button class="btn btn-primary" style="width:100%; margin-top:5px" onclick="processPaste()">üîç Soi Chi·∫øu</button>
                    </div>
                    <div id="mode-file" style="display:none; padding:10px; border:2px dashed #ddd; text-align:center">
                        <input type="file" id="import-file" accept=".xlsx, .xls">
                    </div>
                    <div id="preview-box" style="display:none; flex:1; flex-direction:column; margin-top:15px; border-top:2px solid #f1f5f9; padding-top:10px;">
                        <div style="overflow-y:auto; flex:1; min-height:200px;">
                            <table id="preview-table">
                                <thead><tr><th style="width:130px">M√£ SP</th><th>T√™n H√†ng H√≥a</th><th>ƒê∆°n V·ªã</th><th>L√¥</th><th>H·∫°n</th><th>SL</th><th></th></tr></thead>
                                <tbody id="preview-body"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" style="width:100%; margin-top:10px" onclick="syncData()">ƒê·ªíNG B·ªò V√ÄO KHO</button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px; height:auto">
                <div class="card-header">
                    Danh S√°ch T·ªìn Kho
                    <button class="btn btn-danger" style="float:right;" onclick="requestDeleteAll()">‚ö†Ô∏è X√≥a T·∫•t C·∫£</button>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px">
                    <input type="text" id="search-stock" placeholder="T√¨m ki·∫øm..." style="flex:2">
                    <select id="sort-stock" style="flex:1"><option value="newest">M·ªõi nh·∫≠p</option><option value="name">T√™n A-Z</option></select>
                </div>
                <div style="overflow-x:auto; max-height:500px">
                    <table id="stock-table">
                        <thead><tr><th>STT</th><th>M√£ SP</th><th>T√™n H√†ng H√≥a</th><th>ƒê∆°n V·ªã</th><th>S·ªë L√¥</th><th>H·∫°n D√πng</th><th>T·ªìn</th><th>Thao T√°c</th></tr></thead>
                        <tbody id="stock-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <div class="grid-layout">
                <div class="card">
                    <div class="card-header">A. Xu·∫•t Kho Th·ªß C√¥ng</div>
                    <label>T√¨m s·∫£n ph·∫©m xu·∫•t:</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="exp-name" placeholder="G√µ t√™n thu·ªëc..." autocomplete="off">
                        <div id="exp-suggest" class="autocomplete-items"></div>
                    </div>
                    <div id="lot-list" style="margin-top:10px; min-height:50px"></div>
                    <hr>
                    <div style="display:flex; gap:10px">
                         <input type="number" id="exp-qty" placeholder="SL Xu·∫•t" disabled style="flex:1">
                         <input type="text" id="exp-unit" placeholder="ƒê∆°n v·ªã" readonly style="flex:1; background:#eee">
                    </div>
                    <input type="text" id="exp-dest" placeholder="N∆°i nh·∫≠n">
                    <input type="date" id="exp-date">
                    <button class="btn btn-warning" id="btn-export" style="width:100%" disabled onclick="confirmExport()">X√ÅC NH·∫¨N XU·∫§T</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        B. Xu·∫•t H√†ng Lo·∫°t (Auto FIFO)
                        <div style="float:right">
                            <button class="btn btn-primary" onclick="toggleExportMode('paste')">Paste</button>
                            <button class="btn btn-warning" onclick="toggleExportMode('file')">Excel</button>
                        </div>
                    </div>
                    
                    <div id="exp-mode-paste">
                        <p style="font-size:0.85rem; color:#64748b; margin-bottom:5px">C·∫•u tr√∫c: <b>STT | M√£ SP | T√™n SP | ƒêVT | S·ªë l∆∞·ª£ng</b></p>
                        <textarea id="exp-paste-area" style="height:80px; width:100%; border:2px dashed #f59e0b; background:#fffbf0"></textarea>
                        <button class="btn btn-primary" style="width:100%; margin-top:5px" onclick="processExportPaste()">üîç Soi Chi·∫øu & L·∫•y H√†ng</button>
                    </div>
                    
                    <div id="exp-mode-file" style="display:none; padding:10px; border:2px dashed #ddd; text-align:center">
                         <p style="font-size:0.85rem; color:#64748b; margin-bottom:5px">Excel: <b>STT | M√£ SP | T√™n | ƒêVT | S·ªë l∆∞·ª£ng</b></p>
                        <input type="file" id="export-file-input" accept=".xlsx, .xls">
                    </div>

                    <div id="exp-preview-box" style="display:none; flex:1; flex-direction:column; margin-top:15px; border-top:2px solid #f1f5f9; padding-top:10px;">
                        <div style="margin-bottom:5px">
                            <label>N∆°i nh·∫≠n chung:</label>
                            <input type="text" id="bulk-exp-dest" placeholder="V√≠ d·ª•: Kho l·∫ª, Kh√°ch A..." style="margin-bottom:5px">
                            <label>Ng√†y xu·∫•t:</label>
                            <input type="date" id="bulk-exp-date" style="margin-bottom:5px">
                        </div>
                        <div style="overflow-y:auto; flex:1; min-height:200px;">
                            <table id="exp-preview-table">
                                <thead>
                                    <tr>
                                        <th>M√£ SP</th>
                                        <th>T√™n H√†ng H√≥a</th>
                                        <th>L√¥ (G·ª£i √Ω)</th>
                                        <th>H·∫°n D√πng</th>
                                        <th style="width:80px">SL Xu·∫•t</th>
                                        <th style="width:50px"></th>
                                    </tr>
                                </thead>
                                <tbody id="exp-preview-body"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-danger" style="width:100%; margin-top:10px" onclick="executeBulkExport()">‚ö° X√ÅC NH·∫¨N TR·ª™ KHO</button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px; height:auto">
                <div class="card-header">L·ªãch S·ª≠ Xu·∫•t Kho</div>
                <button class="btn btn-success" style="width:100%; margin-bottom:10px" onclick="openSignatureModal()">Xu·∫•t Excel L·ªãch S·ª≠</button>
                <div id="export-list" style="overflow-y:auto; flex:1; max-height:500px; border:1px solid #f1f5f9; padding:5px; border-radius:6px;"></div>
            </div>

            <div class="card" style="margin-top:20px; height:auto">
                <div class="card-header">B√°o C√°o Nh·∫≠p Xu·∫•t T·ªìn</div>
                <div style="display:flex; gap:10px">
                    <input type="date" id="rpt-start">
                    <input type="date" id="rpt-end">
                    <button class="btn btn-primary" onclick="genReport()">Xem</button>
                    <button class="btn btn-success" onclick="exportReportExcel()">Excel</button>
                </div>
                <div style="overflow-x:auto; margin-top:10px">
                    <table id="rpt-table">
                        <thead><tr><th>M√£ SP</th><th>T√™n H√†ng H√≥a</th><th>ƒê∆°n V·ªã</th><th>T·ªìn ƒê·∫ßu</th><th>Nh·∫≠p</th><th>Xu·∫•t</th><th>T·ªìn Cu·ªëi</th></tr></thead>
                        <tbody id="rpt-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="app-footer" id="app-footer">
            H·ªá th·ªëng qu·∫£n l√Ω kho d∆∞·ª£c IDECO.
        </div>
    </div>

    <div id="delete-security-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10002; align-items:center; justify-content:center;">
        <div style="background:white; padding:25px; border-radius:12px; width:90%; max-width:400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
            <h3 style="color:var(--danger); margin-top:0;">‚ö†Ô∏è X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU</h3>
            <p style="color:#666; font-size:0.9rem;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. Vui l√≤ng khai b√°o danh t√≠nh.</p>
            <label>T√™n ng∆∞·ªùi x√≥a (*)</label>
            <input type="text" id="del-user-name" placeholder="Nh·∫≠p h·ªç t√™n...">
            <label>M·∫≠t kh·∫©u qu·∫£n tr·ªã (*)</label>
            <input type="password" id="del-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px">
                <button class="btn btn-danger" onclick="confirmDeleteAll()">X√ÅC NH·∫¨N X√ìA</button>
                <button class="btn btn-light" onclick="document.getElementById('delete-security-modal').style.display='none'" style="border:1px solid #ccc; color:#333">H·ªßy b·ªè</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:400px;">
            <h3>S·ª≠a T·ªìn Kho</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="edit-name" placeholder="T√™n">
            <input type="text" id="edit-code" placeholder="M√£">
            <input type="text" id="edit-unit" placeholder="ƒê∆°n v·ªã">
            <input type="text" id="edit-lot" placeholder="L√¥">
            <input type="date" id="edit-exp">
            <input type="number" id="edit-qty">
            <div style="display:flex; justify-content:flex-end; gap:10px">
                <button class="btn btn-success" onclick="saveEdit()">L∆∞u</button>
                <button class="btn btn-danger" onclick="document.getElementById('edit-modal').style.display='none'">H·ªßy</button>
            </div>
        </div>
    </div>

    <div id="edit-export-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:400px;">
            <h3 style="color:var(--warning)">S·ª≠a Phi·∫øu Xu·∫•t</h3>
            <input type="hidden" id="edit-ex-id">
            <input type="hidden" id="edit-ex-related">
            <input type="hidden" id="edit-ex-old-qty">
            <label>T√™n H√†ng H√≥a</label>
            <input type="text" id="edit-ex-name" disabled style="background:#eee">
            <label>S·ªë L∆∞·ª£ng Xu·∫•t</label>
            <input type="number" id="edit-ex-qty">
            <label>N∆°i Nh·∫≠n</label>
            <input type="text" id="edit-ex-dest">
            <label>Ng√†y Xu·∫•t</label>
            <input type="date" id="edit-ex-date">
            <div style="display:flex; justify-content:flex-end; gap:10px">
                <button class="btn btn-warning" onclick="saveExportEdit()">C·∫≠p Nh·∫≠t</button>
                <button class="btn btn-danger" onclick="document.getElementById('edit-export-modal').style.display='none'">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="signature-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10005; align-items:center; justify-content:center;">
        <div style="background:white; padding:25px; border-radius:12px; width:90%; max-width:400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h3 style="color:var(--primary); margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üñ®Ô∏è X√ÅC NH·∫¨N IN B√ÅO C√ÅO</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px">Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám ƒë·ªÉ l∆∞u v√†o file.</p>
            
            <label>1. Ph·ª• Tr√°ch Kho (*)</label>
            <input type="text" id="sign-keeper" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
            
            <label>2. Qu·∫£n L√Ω K·∫ø To√°n/Kho (*)</label>
            <input type="text" id="sign-manager" placeholder="V√≠ d·ª•: Tr·∫ßn Th·ªã B">
            
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px">
                <button class="btn btn-primary" onclick="processExportWithSignature()">XU·∫§T FILE EXCEL</button>
                <button class="btn btn-light" onclick="document.getElementById('signature-modal').style.display='none'" style="border:1px solid #ccc; color:#333">H·ªßy</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Th√¥ng b√°o</div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB54vAqmLmkMPq-L0X69oRS2DdVxxtrLPc",
            authDomain: "quanlykho-5c64f.firebaseapp.com",
            projectId: "quanlykho-5c64f",
            storageBucket: "quanlykho-5c64f.firebasestorage.app",
            messagingSenderId: "106024120320",
            appId: "1:106024120320:web:ede1dae16cb6cccd42e8e5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const refs = { 
            items: db.ref('pharmaceuticals'), 
            master: db.ref('excelFiles'), 
            exports: db.ref('exports'),
            logs: db.ref('systemLogs') 
        };

        let stockData=[], exportData=[], masterData=[], previewData=[], currentExportLot=null;
        let bulkExportPreviewData = []; // Store calculated FIFO export plan

        // INIT DATE
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('imp-date').value = today;
        document.getElementById('exp-date').value = today;
        document.getElementById('bulk-exp-date').value = today;
        document.getElementById('rpt-start').valueAsDate = new Date(new Date().getFullYear(), 0, 1);
        document.getElementById('rpt-end').valueAsDate = new Date();

        // LOADING DATA
        refs.master.on('value', s => { const d=s.val(); const f=d?Object.keys(d).map(k=>({id:k,...d[k]})):[]; renderMasterFilesList(f); refreshMasterData(f); });
        refs.items.on('value', s => { const d=s.val(); stockData=d?Object.keys(d).map(k=>({id:k,...d[k]})):[]; renderStockTable(); refs.master.once('value', s=>{const fd=s.val();const f=fd?Object.keys(fd).map(k=>({id:k,...fd[k]})):[]; refreshMasterData(f);}); });
        refs.exports.on('value', s => { const d=s.val(); exportData=d?Object.keys(d).map(k=>({id:k,...d[k]})):[]; renderExportHistory(); });
        
        refs.logs.on('value', s => {
            const log = s.val();
            const footer = document.getElementById('app-footer');
            if(log && log.lastDeletedBy) {
                const date = new Date(log.deletedAt).toLocaleString('vi-VN');
                footer.innerHTML = `‚ö†Ô∏è D·ªØ li·ªáu b·ªã x√≥a to√†n b·ªô l·∫ßn cu·ªëi b·ªüi: <b>${log.lastDeletedBy}</b> v√†o l√∫c ${date}`;
                footer.style.color = '#ef4444';
            } else {
                footer.innerHTML = 'H·ªá th·ªëng qu·∫£n l√Ω kho d∆∞·ª£c IDECO - An to√†n.';
                footer.style.color = '#64748b';
            }
        });

        // LOGIC FUNCTIONS
        function cleanStr(str) { if(!str) return ''; return str.toString().toLowerCase().replace(/^th[_\-\s]+|thu·ªëc\s+/g, '').trim(); }
        function findColumnValue(row, names) { const keys=Object.keys(row); const lower=keys.map(k=>k.toLowerCase().trim()); for(const n of names) { const idx=lower.indexOf(n.toLowerCase()); if(idx!==-1) return row[keys[idx]]; } return null; }

        function refreshMasterData(files) {
            const map = new Map();
            files.forEach(f => { if(f.data) f.data.forEach(r => { const name = findColumnValue(r, ['T√™n H√†ng H√≥a','T√™n','Product Name']); const code = findColumnValue(r, ['M√£ SP','M√£','Code']); const unit = findColumnValue(r, ['ƒê∆°n V·ªã','Unit']); if(name) { const k=cleanStr(name); map.set(k, { name: name, code: code||'', unit: unit||'', searchKey: k }); } }); });
            stockData.forEach(s => { if(s.productName) { const k=cleanStr(s.productName); if(!map.has(k)) map.set(k, { name: s.productName, code: s.productCode||'', unit: s.unit||'', searchKey: k }); } });
            masterData = Array.from(map.values());
            document.getElementById('master-status').innerText = `‚úÖ ƒê√£ h·ªçc ${masterData.length} m√£.`;
            document.getElementById('master-code-list').innerHTML = masterData.filter(m => m.code).map(m => `<option value="${m.code}">${m.name}</option>`).join('');
        }

        function findBestMatch(inputName) { if (!inputName) return null; const cleanInput = cleanStr(inputName); let match = masterData.find(m => m.searchKey === cleanInput); if (match) return match; return masterData.find(m => cleanInput.includes(m.searchKey) || m.searchKey.includes(cleanInput)); }

        // AUTOCOMPLETE
        function showSuggestions(input, type, container, callback) {
            const val = cleanStr(input.value); container.innerHTML = ''; if(!val) return;
            let matches = [];
            if(type === 'name') matches = masterData.filter(m => m.searchKey.includes(val) || (m.code && m.code.toLowerCase().includes(val))).slice(0, 10);
            else if (type === 'code') matches = masterData.filter(m => (m.code && m.code.toLowerCase().includes(val))).slice(0, 10);

            matches.forEach(m => {
                const div = document.createElement('div'); div.className = 'autocomplete-item';
                div.innerHTML = `<div><strong>${m.name}</strong></div><small style="color:#059669">${m.code||'--'}</small>`;
                div.onmousedown = (e) => { e.preventDefault(); callback(m); container.innerHTML = ''; };
                container.appendChild(div);
            });
        }

        document.getElementById('imp-name').addEventListener('input', function() { showSuggestions(this, 'name', document.getElementById('imp-suggest'), (m) => { this.value = m.name; document.getElementById('imp-code').value = m.code||''; document.getElementById('imp-unit').value = m.unit||''; }); });
        document.getElementById('imp-name').addEventListener('blur', () => setTimeout(() => document.getElementById('imp-suggest').innerHTML='', 200));

        // --- IMPORT LOGIC ---
        document.getElementById('import-file').addEventListener('change', e => {
            const f=e.target.files[0]; if(!f) return;
            const r=new FileReader(); r.onload=evt=>{
                const wb=XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                const ws=wb.Sheets[wb.SheetNames[0]];
                const rows=XLSX.utils.sheet_to_json(ws, {header: 1});
                if(!rows || rows.length===0) return;
                let data=[];
                const hasHeader=rows[0].join(' ').toLowerCase().includes('t√™n');
                if(hasHeader) {
                    const json=XLSX.utils.sheet_to_json(ws);
                    data=json.map(r=>({ name:findColumnValue(r,['T√™n H√†ng H√≥a','T√™n']), unit:findColumnValue(r,['ƒê∆°n V·ªã','Unit']), lot:findColumnValue(r,['S·ªë L√¥','L√¥']), exp:parseDate(findColumnValue(r,['H·∫°n S·ª≠ D·ª•ng','H·∫°n'])), qty:findColumnValue(r,['S·ªë L∆∞·ª£ng','SL']) }));
                } else {
                    data=rows.map(r=>({ name:r[1], unit:r[2], lot:r[3], exp:parseDate(r[4]), qty:r[5] })).filter(d=>d.name);
                }
                generatePreview(data);
            }; r.readAsArrayBuffer(f);
        });

        window.processPaste=()=>{ const txt=document.getElementById('paste-area').value; if(!txt) return; const rows=txt.trim().split('\n').map(r=>r.split('\t')); const data=rows.map(c=>({ name:c[1], unit:c[2], lot:c[3], exp:parseDate(c[4]), qty:c[5] })); generatePreview(data); }

        function generatePreview(data) {
            previewData = data.map((d, i) => { const match = findBestMatch(d.name); return { id: i, productName: d.name, productCode: match ? match.code : '', unit: d.unit || (match ? match.unit : ''), lotNumber: d.lot, expiryDate: d.exp, quantity: d.qty }; });
            renderPreviewTable(); document.getElementById('preview-box').style.display='flex';
        }

        function renderPreviewTable() {
            const tb = document.getElementById('preview-body'); tb.innerHTML = '';
            previewData.forEach((d, i) => {
                const tr = document.createElement('tr');
                const tdCode = document.createElement('td'); tdCode.style.position='relative';
                const inpCode = document.createElement('input'); inpCode.className = 'table-input ' + (d.productCode?'code-found':''); inpCode.list="master-code-list"; inpCode.value = d.productCode || '';
                const sugCode = document.createElement('div'); sugCode.className = 'autocomplete-items';
                inpCode.oninput = function() { d.productCode = this.value; showSuggestions(this, 'code', sugCode, (m) => { d.productCode = m.code; d.productName = m.name; d.unit = m.unit; this.value = m.code; tr.querySelector('.inp-name').value = m.name; tr.querySelector('.inp-unit').value = m.unit; }); };
                inpCode.onblur = () => setTimeout(()=>sugCode.innerHTML='', 200);
                tdCode.append(inpCode, sugCode);

                const tdName = document.createElement('td'); tdName.style.position='relative';
                const inpName = document.createElement('input'); inpName.className = 'table-input inp-name'; inpName.value = d.productName || '';
                const sugName = document.createElement('div'); sugName.className = 'autocomplete-items';
                inpName.oninput = function() { d.productName = this.value; showSuggestions(this, 'name', sugName, (m) => { d.productName = m.name; d.productCode = m.code; d.unit = m.unit; this.value = m.name; tr.querySelector('.table-input').value = m.code; tr.querySelector('.inp-unit').value = m.unit; }); };
                inpName.onblur = () => setTimeout(()=>sugName.innerHTML='', 200);
                tdName.append(inpName, sugName);

                const tdUnit = document.createElement('td'); tdUnit.innerHTML = `<input class="table-input inp-unit" value="${d.unit||''}" onchange="previewData[${i}].unit=this.value">`;
                const tdLot = document.createElement('td'); tdLot.innerHTML = `<input class="table-input" value="${d.lotNumber||''}" onchange="previewData[${i}].lotNumber=this.value">`;
                const tdExp = document.createElement('td'); tdExp.innerHTML = `<input type="date" class="table-input" value="${d.expiryDate||''}" onchange="previewData[${i}].expiryDate=this.value">`;
                const tdQty = document.createElement('td'); tdQty.innerHTML = `<input type="number" class="table-input" value="${d.quantity||''}" onchange="previewData[${i}].quantity=this.value">`;
                const tdAct = document.createElement('td'); tdAct.innerHTML = `<button class="btn btn-danger" style="padding:2px 5px" onclick="removePreviewItem(${i})">X</button>`;
                tr.append(tdCode, tdName, tdUnit, tdLot, tdExp, tdQty, tdAct); tb.appendChild(tr);
            });
        }
        window.removePreviewItem = (i) => { previewData.splice(i, 1); renderPreviewTable(); }
        window.syncData = async () => { let c=0; for(const d of previewData) { if(d.productName && d.quantity) { await saveToInventory({ productName: d.productName, productCode: d.productCode, unit: d.unit, lotNumber: d.lotNumber, expiryDate: d.expiryDate, quantity: parseInt(d.quantity), importDate: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString() }); c++; } } showToast(`ƒê√£ nh·∫≠p ${c} d√≤ng`, 'success'); document.getElementById('preview-box').style.display='none'; }

        async function saveToInventory(item) {
            const exist = stockData.find(s => {
                const isBatchMatch = s.lotNumber === item.lotNumber && s.expiryDate === item.expiryDate;
                if (!isBatchMatch) return false;
                const sCode = (s.productCode || '').trim().toLowerCase();
                const iCode = (item.productCode || '').trim().toLowerCase();
                const sName = (s.productName || '').trim().toLowerCase();
                const iName = (item.productName || '').trim().toLowerCase();
                if (iCode.length > 0) return sCode === iCode;
                return sName === iName;
            });

            if(exist) {
                await refs.items.child(exist.id).update({ 
                    quantity: parseInt(exist.quantity) + parseInt(item.quantity), 
                    unit: item.unit, 
                    productCode: item.productCode || exist.productCode 
                });
            } else {
                await refs.items.push(item);
            }
        }

        // --- EXPORT HISTORY FUNCTIONS ---
        function renderExportHistory() {
            const div = document.getElementById('export-list'); div.innerHTML = '';
            const list = exportData.sort((a,b)=>new Date(b.exportDate)-new Date(a.exportDate));
            if(list.length === 0) { div.innerHTML='<div style="padding:10px; color:#999; text-align:center">Ch∆∞a c√≥ l·ªãch s·ª≠ xu·∫•t.</div>'; return; }
            list.forEach(e => {
                const item = document.createElement('div'); item.className = 'export-item';
                item.innerHTML = `<div class="export-info"><strong>${e.productName}</strong> <span style="color:var(--secondary); font-weight:bold;">[${e.productCode || '--'}]</span> <span style="color:#666">(${e.unit || '-'})</span><br><small>L√¥: ${e.lotNumber} | H·∫°n: ${e.expiryDate} | SL: <b style="color:var(--danger)">${e.quantity}</b></small><br><small style="color:#888">Ng√†y: ${e.exportDate} -> ${e.destination}</small></div><div class="export-actions"><button class="btn btn-warning" onclick="openEditExport('${e.id}')">S·ª≠a</button><button class="btn btn-danger" onclick="deleteExport('${e.id}')">X√≥a</button></div>`;
                div.appendChild(item);
            });
        }
        window.deleteExport = async (id) => {
            if(!confirm('X√≥a phi·∫øu xu·∫•t v√† ho√†n kho?')) return;
            const ex = exportData.find(x => x.id === id);
            const stk = stockData.find(s => s.id === ex.relatedId);
            if(stk) await refs.items.child(stk.id).update({ quantity: parseInt(stk.quantity) + parseInt(ex.quantity) });
            await refs.exports.child(id).remove();
            showToast('ƒê√£ x√≥a phi·∫øu xu·∫•t', 'success');
        }
        window.openEditExport = (id) => {
            const ex = exportData.find(x => x.id === id);
            document.getElementById('edit-ex-id').value = id;
            document.getElementById('edit-ex-related').value = ex.relatedId;
            document.getElementById('edit-ex-old-qty').value = ex.quantity;
            document.getElementById('edit-ex-name').value = ex.productName;
            document.getElementById('edit-ex-qty').value = ex.quantity;
            document.getElementById('edit-ex-dest').value = ex.destination;
            document.getElementById('edit-ex-date').value = ex.exportDate;
            document.getElementById('edit-export-modal').style.display = 'flex';
        }
        window.saveExportEdit = async () => {
            const id = document.getElementById('edit-ex-id').value;
            const relatedId = document.getElementById('edit-ex-related').value;
            const oldQty = parseInt(document.getElementById('edit-ex-old-qty').value);
            const newQty = parseInt(document.getElementById('edit-ex-qty').value);
            const newDest = document.getElementById('edit-ex-dest').value;
            const newDate = document.getElementById('edit-ex-date').value;
            if(newQty < 0) return showToast('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá', 'error');
            const stk = stockData.find(s => s.id === relatedId);
            if(!stk) return alert('L√¥ h√†ng g·ªëc ƒë√£ h·∫øt ho·∫∑c b·ªã x√≥a!');
            const stockAfterRevert = parseInt(stk.quantity) + oldQty;
            if(newQty > stockAfterRevert) return alert(`Kh√¥ng ƒë·ªß t·ªìn kho! T·ªëi ƒëa: ${stockAfterRevert}`);
            await refs.items.child(relatedId).update({ quantity: stockAfterRevert - newQty });
            await refs.exports.child(id).update({ quantity: newQty, destination: newDest, exportDate: newDate });
            document.getElementById('edit-export-modal').style.display = 'none';
            showToast('ƒê√£ c·∫≠p nh·∫≠t', 'success');
        }

        // --- SIGNATURE EXPORT ---
        window.openSignatureModal = () => {
            if(exportData.length === 0) return showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
            document.getElementById('signature-modal').style.display = 'flex';
            document.getElementById('sign-keeper').value = '';
            document.getElementById('sign-manager').value = '';
        }

        window.processExportWithSignature = () => {
            const keeper = document.getElementById('sign-keeper').value.trim();
            const manager = document.getElementById('sign-manager').value.trim();
            
            if(!keeper || !manager) {
                return alert('Vui l√≤ng nh·∫≠p ƒë·ªß t√™n 2 ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám!');
            }
            
            document.getElementById('signature-modal').style.display = 'none';
            exportHistoryWithSignatures(keeper, manager);
        }

        function exportHistoryWithSignatures(keeper, manager) {
            const title = [['B√ÅO C√ÅO L·ªäCH S·ª¨ XU·∫§T KHO - IDECO']];
            const dateInfo = [[`Ng√†y xu·∫•t b√°o c√°o: ${new Date().toLocaleString('vi-VN')}`], ['']];
            const headers = [['Ng√†y Xu·∫•t', 'M√£ SP', 'T√™n H√†ng H√≥a', 'ƒê∆°n V·ªã', 'S·ªë L√¥', 'H·∫°n D√πng', 'N∆°i Nh·∫≠n', 'S·ªë L∆∞·ª£ng']];
            const body = exportData.map(e => [e.exportDate,e.productCode || '',e.productName,e.unit || '',e.lotNumber,e.expiryDate,e.destination,e.quantity]);
            const footer = [['', '', '', '', '', '', '', ''],['', '', '', '', '', '', '', ''],['NG∆Ø·ªúI L·∫¨P B·∫¢O C√ÅO', '', '', '', 'X√ÅC NH·∫¨N C·ª¶A QU·∫¢N L√ù', '', '', ''],['(Ph·ª• tr√°ch kho)', '', '', '', '(Qu·∫£n l√Ω K·∫ø to√°n/Kho)', '', '', ''],['', '', '', '', '', '', '', ''],['', '', '', '', '', '', '', ''],[`${keeper}`, '', '', '', `${manager}`, '', '', '']];
            const fullData = [...title, ...dateInfo, ...headers, ...body, ...footer];
            const ws = XLSX.utils.aoa_to_sheet(fullData);
            ws['!cols'] = [{wch:15}, {wch:15}, {wch:30}, {wch:10}, {wch:15}, {wch:15}, {wch:20}, {wch:10}];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "LichSuXuat");
            XLSX.writeFile(wb, `LichSuXuat_Signed_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('ƒê√£ xu·∫•t file k√®m ch·ªØ k√Ω!', 'success');
        }

        // --- MANUAL EXPORT ---
        document.getElementById('exp-name').addEventListener('input', function(){
            const v=cleanStr(this.value); const l=document.getElementById('exp-suggest'); l.innerHTML=''; if(!v)return;
            const m=stockData.filter(d=>parseInt(d.quantity)>0 && cleanStr(d.productName).includes(v));
            [...new Set(m.map(x=>x.productName))].forEach(n=>{
                const d=document.createElement('div'); d.className='autocomplete-item'; d.innerText=n; d.onmousedown=(e)=>{e.preventDefault(); handleProductClick(n);l.innerHTML='';}; l.appendChild(d);
            });
        });
        document.getElementById('exp-name').addEventListener('blur', ()=>setTimeout(()=>document.getElementById('exp-suggest').innerHTML='',200));

        window.handleProductClick = function(name) {
            document.getElementById('btn-tab2').click(); window.scrollTo({top:0,behavior:'smooth'}); document.getElementById('exp-name').value=name;
            const l=document.getElementById('lot-list'); l.innerHTML='';
            stockData.filter(d=>d.productName===name && parseInt(d.quantity)>0).sort((a,b)=>new Date(a.expiryDate)-new Date(b.expiryDate)).forEach((lot,i)=>{
                const el=document.createElement('div'); el.style.padding='10px'; el.style.border=i===0?'2px solid green':'1px solid #ddd'; el.style.margin='5px 0';
                el.innerHTML=`M√£: <b>${lot.productCode||'--'}</b> | L√¥: <b>${lot.lotNumber}</b> | H·∫°n: ${lot.expiryDate} | SL: ${lot.quantity}`;
                el.onclick=()=>{ currentExportLot=lot; document.getElementById('exp-qty').disabled=false; document.getElementById('exp-qty').max=lot.quantity; document.getElementById('exp-unit').value=lot.unit||''; document.getElementById('btn-export').disabled=false; };
                l.appendChild(el);
            });
        }
        
        window.confirmExport = async () => {
            const q = parseInt(document.getElementById('exp-qty').value);
            if(!currentExportLot) return;
            const currentStock = parseInt(currentExportLot.quantity);
            if(q > currentStock) { showToast(`Xu·∫•t kho v∆∞·ª£t qu√° t·ªìn kho! (T·ªìn: ${currentStock})`, 'error'); return; }
            if(q <= 0) { showToast(`S·ªë l∆∞·ª£ng xu·∫•t kh√¥ng h·ª£p l·ªá!`, 'error'); return; }

            await refs.exports.push({productName:currentExportLot.productName, productCode: currentExportLot.productCode, unit: currentExportLot.unit, lotNumber: currentExportLot.lotNumber, expiryDate: currentExportLot.expiryDate, quantity:q, destination:document.getElementById('exp-dest').value, exportDate:document.getElementById('exp-date').value, relatedId:currentExportLot.id});
            await refs.items.child(currentExportLot.id).update({quantity:currentStock - q});
            showToast('Xu·∫•t OK','success'); document.getElementById('lot-list').innerHTML=''; document.getElementById('exp-qty').value=''; document.getElementById('btn-export').disabled=true;
        }

        // ============================================================
        // === NEW: BULK EXPORT LOGIC (FIFO) ==========================
        // ============================================================
        
        window.toggleExportMode = (m) => {
            document.getElementById('exp-mode-paste').style.display = m==='paste'?'block':'none';
            document.getElementById('exp-mode-file').style.display = m==='file'?'block':'none';
        }

        document.getElementById('export-file-input').addEventListener('change', e => {
            const f=e.target.files[0]; if(!f) return;
            const r=new FileReader(); 
            r.onload=evt=>{
                const wb=XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                const ws=wb.Sheets[wb.SheetNames[0]];
                const rows=XLSX.utils.sheet_to_json(ws, {header: 1});
                if(!rows || rows.length===0) return;
                // STT | M√£ SP | T√™n | ƒêVT | SL
                let data = [];
                // Skip header if first row has text like 'M√£'
                const startIdx = rows[0].join('').toLowerCase().includes('m√£') ? 1 : 0;
                for(let i=startIdx; i<rows.length; i++){
                    const r = rows[i];
                    if(r[1] || r[2]) { // Must have Code or Name
                        data.push({ code: r[1], name: r[2], unit: r[3], qty: r[4] });
                    }
                }
                processBulkExportInput(data);
            }; 
            r.readAsArrayBuffer(f);
        });

        window.processExportPaste = () => {
            const txt = document.getElementById('exp-paste-area').value; 
            if(!txt) return; 
            const rows = txt.trim().split('\n').map(r=>r.split('\t')); 
            // Expect: STT | Code | Name | Unit | Qty (Indices: 0, 1, 2, 3, 4)
            const data = rows.map(c => ({ code:c[1], name:c[2], unit:c[3], qty:c[4] }));
            processBulkExportInput(data);
        }

        function processBulkExportInput(inputData) {
            bulkExportPreviewData = []; // Reset preview
            
            inputData.forEach((req) => {
                let reqQty = parseInt(req.qty);
                if (!reqQty || reqQty <= 0) return;

                // 1. Find matching stock items (By Code first, then Name)
                let matches = [];
                const searchCode = cleanStr(req.code);
                const searchName = cleanStr(req.name);

                if (searchCode) {
                    matches = stockData.filter(s => cleanStr(s.productCode) === searchCode && parseInt(s.quantity) > 0);
                }
                // If no code match, try name
                if (matches.length === 0 && searchName) {
                    matches = stockData.filter(s => cleanStr(s.productName) === searchName && parseInt(s.quantity) > 0);
                }

                // 2. Sort Matches by Expiry Date (Ascending - FIFO)
                matches.sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));

                // 3. Check Total Stock
                const totalStock = matches.reduce((sum, item) => sum + parseInt(item.quantity), 0);

                if (reqQty > totalStock) {
                    // Not enough stock -> Add Error Row
                    bulkExportPreviewData.push({
                        isError: true,
                        productCode: req.code || '?',
                        productName: req.name || 'S·∫£n ph·∫©m ch∆∞a x√°c ƒë·ªãnh',
                        reqQty: reqQty,
                        totalStock: totalStock,
                        msg: `Thi·∫øu h√†ng! (C·∫ßn: ${reqQty}, C√≥: ${totalStock})`
                    });
                } else {
                    // Enough stock -> Distribute (FIFO)
                    for (let batch of matches) {
                        if (reqQty <= 0) break;
                        
                        let available = parseInt(batch.quantity);
                        let take = Math.min(available, reqQty);

                        bulkExportPreviewData.push({
                            isError: false,
                            relatedId: batch.id, // Important: to update firebase later
                            productCode: batch.productCode,
                            productName: batch.productName,
                            unit: batch.unit,
                            lotNumber: batch.lotNumber,
                            expiryDate: batch.expiryDate,
                            exportQty: take,
                            originalStock: available
                        });

                        reqQty -= take;
                    }
                }
            });

            renderBulkExportPreview();
            document.getElementById('exp-preview-box').style.display = 'flex';
        }

        function renderBulkExportPreview() {
            const tb = document.getElementById('exp-preview-body'); 
            tb.innerHTML = '';
            
            if(bulkExportPreviewData.length === 0) {
                tb.innerHTML = '<tr><td colspan="6" style="text-align:center">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá.</td></tr>';
                return;
            }

            bulkExportPreviewData.forEach((d, i) => {
                const tr = document.createElement('tr');
                if (d.isError) {
                    tr.className = 'row-error';
                    tr.innerHTML = `
                        <td>${d.productCode}</td>
                        <td>${d.productName}</td>
                        <td colspan="3" style="color:#b91c1c; font-weight:bold">${d.msg}</td>
                        <td><button class="btn btn-danger" style="padding:2px 5px" onclick="removeBulkItem(${i})">X</button></td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>${d.productCode}</td>
                        <td><b>${d.productName}</b></td>
                        <td>${d.lotNumber} <small style="color:#666">(T·ªìn: ${d.originalStock})</small></td>
                        <td>${d.expiryDate}</td>
                        <td style="font-weight:bold; color:var(--primary); text-align:center">${d.exportQty}</td>
                        <td><button class="btn btn-danger" style="padding:2px 5px" onclick="removeBulkItem(${i})">X</button></td>
                    `;
                }
                tb.appendChild(tr);
            });
        }

        window.removeBulkItem = (i) => {
            bulkExportPreviewData.splice(i, 1);
            renderBulkExportPreview();
        }

        window.executeBulkExport = async () => {
            // Check if errors exist
            if (bulkExportPreviewData.some(d => d.isError)) {
                return alert('Vui l√≤ng lo·∫°i b·ªè c√°c d√≤ng l·ªói (m√†u ƒë·ªè) tr∆∞·ªõc khi xu·∫•t kho!');
            }
            if (bulkExportPreviewData.length === 0) return;

            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn xu·∫•t ${bulkExportPreviewData.length} m·ª•c kh√¥ng? Kho s·∫Ω b·ªã tr·ª´ ngay l·∫≠p t·ª©c.`)) return;

            const dest = document.getElementById('bulk-exp-dest').value || 'Kh√°ch l·∫ª/Kh√¥ng x√°c ƒë·ªãnh';
            const date = document.getElementById('bulk-exp-date').value;

            let count = 0;
            for (let item of bulkExportPreviewData) {
                // 1. Get current stock from DB to be safe (Concurrency check simplified)
                // Since this is a simple app, we trust stockData from listener but verify logic
                const stockItem = stockData.find(s => s.id === item.relatedId);
                
                if (stockItem) {
                    const currentQty = parseInt(stockItem.quantity);
                    if (currentQty >= item.exportQty) {
                        // Push Export Record
                        await refs.exports.push({
                            productName: item.productName,
                            productCode: item.productCode || '',
                            unit: item.unit || '',
                            lotNumber: item.lotNumber,
                            expiryDate: item.expiryDate,
                            quantity: item.exportQty,
                            destination: dest,
                            exportDate: date,
                            relatedId: item.relatedId
                        });

                        // Deduct Stock
                        await refs.items.child(item.relatedId).update({
                            quantity: currentQty - item.exportQty
                        });
                        count++;
                    }
                }
            }

            showToast(`ƒê√£ xu·∫•t th√†nh c√¥ng ${count} m·ª•c!`, 'success');
            document.getElementById('exp-preview-box').style.display = 'none';
            document.getElementById('exp-paste-area').value = '';
            document.getElementById('export-file-input').value = '';
            bulkExportPreviewData = [];
        }

        // --- SECURITY DELETE ---
        window.requestDeleteAll = () => { document.getElementById('delete-security-modal').style.display='flex'; }
        window.confirmDeleteAll = async () => {
            const name = document.getElementById('del-user-name').value;
            const pass = document.getElementById('del-password').value;
            if(pass !== 'ideco2025') return showToast('M·∫≠t kh·∫©u sai!', 'error');
            if(!name) return showToast('Vui l√≤ng nh·∫≠p t√™n!', 'error');
            if(confirm('C·∫¢NH B√ÅO CU·ªêI C√ôNG: B·∫°n c√≥ ch·∫Øc ch·∫Øn x√≥a vƒ©nh vi·ªÖn kh√¥ng?')) {
                await refs.items.remove(); await refs.exports.remove(); 
                await refs.logs.set({ lastDeletedBy: name, deletedAt: new Date().toISOString() });
                document.getElementById('delete-security-modal').style.display='none'; showToast('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu h·ªá th·ªëng!', 'success');
            }
        }

        // UTILS
        function parseDate(v) { if(!v)return ''; if(typeof v==='number') return new Date((v-25569)*86400000).toISOString().split('T')[0]; if(v.includes('/')){const p=v.split('/'); if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`;} return v; }
        window.saveManual = async () => { const item={ productName: document.getElementById('imp-name').value.trim(), productCode: document.getElementById('imp-code').value, unit: document.getElementById('imp-unit').value, lotNumber: document.getElementById('imp-lot').value, expiryDate: document.getElementById('imp-exp').value, quantity: document.getElementById('imp-qty').value, importDate: document.getElementById('imp-date').value, createdAt: new Date().toISOString() }; if(!item.productName||!item.lotNumber||!item.quantity) return showToast('Thi·∫øu th√¥ng tin','error'); await saveToInventory(item); showToast('OK','success'); ['imp-name','imp-code','imp-unit','imp-lot','imp-qty'].forEach(id=>document.getElementById(id).value=''); }
        function renderStockTable() { const tb=document.getElementById('stock-body'); tb.innerHTML=''; const term=document.getElementById('search-stock').value.toLowerCase(); stockData.filter(d=>(d.productName||'').toLowerCase().includes(term)).forEach((d,i)=>{ tb.innerHTML+=`<tr><td>${i+1}</td><td>${d.productCode||''}</td><td><b>${d.productName}</b></td><td>${d.unit||''}</td><td>${d.lotNumber}</td><td>${d.expiryDate}</td><td>${d.quantity}</td><td><button class="btn btn-warning" onclick="editStock('${d.id}')">S·ª≠a</button> <button class="btn btn-danger" onclick="if(confirm('X√≥a?')) refs.items.child('${d.id}').remove()">X√≥a</button></td></tr>`; }); }
        document.getElementById('search-stock').addEventListener('input', renderStockTable);
        window.editStock=(id)=>{ const d=stockData.find(x=>x.id===id); document.getElementById('edit-id').value=id; document.getElementById('edit-name').value=d.productName; document.getElementById('edit-code').value=d.productCode; document.getElementById('edit-unit').value=d.unit; document.getElementById('edit-lot').value=d.lotNumber; document.getElementById('edit-exp').value=d.expiryDate; document.getElementById('edit-qty').value=d.quantity; document.getElementById('edit-modal').style.display='flex'; }
        window.saveEdit=async()=>{ const id=document.getElementById('edit-id').value; await refs.items.child(id).update({ productName:document.getElementById('edit-name').value, productCode:document.getElementById('edit-code').value, unit:document.getElementById('edit-unit').value, lotNumber:document.getElementById('edit-lot').value, expiryDate:document.getElementById('edit-exp').value, quantity:parseInt(document.getElementById('edit-qty').value) }); document.getElementById('edit-modal').style.display='none'; showToast('ƒê√£ l∆∞u','success'); }
        document.getElementById('master-upload').addEventListener('change', e=>{ const f=e.target.files[0]; const r=new FileReader(); r.onload=evt=>{ const wb=XLSX.read(new Uint8Array(evt.target.result),{type:'array'}); const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); refs.master.push({fileName:f.name, data:json}); showToast('OK','success'); }; r.readAsArrayBuffer(f); });
        function renderMasterFilesList(files){ document.getElementById('master-files-list').innerHTML=files.map(f=>`<div>üìÑ ${f.fileName} <a href="#" onclick="refs.master.child('${f.id}').remove()" style="color:red">X√≥a</a></div>`).join(''); }
        
        window.genReport=()=>{ 
            const s=new Date(document.getElementById('rpt-start').value), e=new Date(document.getElementById('rpt-end').value); 
            const r={}; 
            stockData.forEach(i=>{ 
                if(!r[i.productName]) r[i.productName]={name:i.productName, code: i.productCode||'', unit:i.unit||'', in:0, out:0, end:0}; 
                r[i.productName].end+=parseInt(i.quantity); 
            }); 
            document.getElementById('rpt-body').innerHTML=Object.values(r).map(x=>`<tr ondblclick="handleProductClick('${x.name}')"><td>${x.code}</td><td>${x.name}</td><td>${x.unit}</td><td>-</td><td>${x.in}</td><td>${x.out}</td><td>${x.end}</td></tr>`).join(''); 
        }

        window.switchTab=(id,el)=>{ document.querySelectorAll('.tab-content').forEach(d=>d.style.display='none'); document.getElementById(id).style.display='block'; document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); }
        window.toggleMode=(m)=>{ document.getElementById('mode-paste').style.display=m==='paste'?'block':'none'; document.getElementById('mode-file').style.display=m==='file'?'block':'none'; }
        window.toggleMasterSection=()=>{ const el=document.getElementById('master-section'); el.style.display=el.style.display==='none'?'block':'none'; }
        window.showToast=(m,t)=>{ const el=document.getElementById('toast'); el.innerText=m; el.style.background=t==='error'?'#ef4444':'#10b981'; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),3000); }
    </script>
</body>
</html>
