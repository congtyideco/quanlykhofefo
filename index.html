<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kho D∆∞·ª£c GDP - IDECO (Final Logic)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        /* CSS CHU·∫®N - KH√îNG ƒê·ªîI */
        :root { --primary: #2563eb; --secondary: #1e40af; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --light: #f3f4f6; --dark: #1e293b; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.5; color: var(--dark); background: #f1f5f9; padding: 20px; }
        .container { max-width: 1280px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; min-height: 90vh; }
        
        header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 1.5rem; margin: 0; font-weight: 700; }
        
        .nav-tabs { display: flex; background: #e2e8f0; padding: 10px 10px 0; }
        .nav-tab { padding: 10px 20px; cursor: pointer; background: #cbd5e1; margin-right: 4px; border-radius: 6px 6px 0 0; font-weight: 600; color: #475569; transition: 0.2s; }
        .nav-tab.active { background: white; color: var(--primary); border-top: 3px solid var(--primary); }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        .grid-layout { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        @media(max-width:900px) { .grid-layout { grid-template-columns: 1fr; } }
        
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 100%; }
        .card-header { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; }
        
        input, select, textarea { width: 100%; padding: 8px 12px; margin: 5px 0 15px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        label { font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 2px; display: block; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { opacity: 0.9; }
        .btn-success { background: var(--success); } .btn-primary { background: var(--primary); } .btn-danger { background: var(--danger); } .btn-warning { background: var(--warning); }
        
        /* AUTOCOMPLETE STYLE */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-items { position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background: white; border: 1px solid #cbd5e1; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px; }
        .autocomplete-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .autocomplete-item:hover { background: #f1f5f9; }
        .autocomplete-item strong { color: var(--primary); }

        /* TABLE STYLE */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        th { background: #f8fafc; text-align: left; padding: 10px; font-weight: 700; border: 1px solid #e2e8f0; color: #334155; }
        td { padding: 8px; border: 1px solid #e2e8f0; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        .preview-table input { margin: 0; border: 1px solid transparent; background: transparent; width: 100%; }
        .preview-table input:focus { border-color: var(--primary); background: white; }

        .paste-area { font-family: monospace; height: 100px; border: 2px dashed #cbd5e1; background: #f8fafc; resize: vertical; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: 0.3s; z-index: 2000; }
        .toast.show { opacity: 1; transform: translateY(-10px); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>QU·∫¢N L√ù KHO D∆Ø·ª¢C GDP - IDECO</h1>
            <button class="btn btn-warning" onclick="document.getElementById('master-data-box').style.display='block'">
                üìÇ D·ªØ Li·ªáu G·ªëc
            </button>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('tab1', this)">1. NH·∫¨P KHO & T·ªíN KHO</div>
            <div class="nav-tab" onclick="switchTab('tab2', this)" id="btn-tab2">2. XU·∫§T KHO & B√ÅO C√ÅO</div>
        </div>

        <div id="tab1" class="tab-content active">
            
            <div id="master-data-box" style="display:none; background:#fffbeb; padding:15px; margin-bottom:20px; border-radius:8px; border:1px solid #fbbf24;">
                <h3 style="margin-top:0; color:#92400e">C·∫≠p nh·∫≠t Danh M·ª•c G·ªëc (M√£ - T√™n)</h3>
                <p style="font-size:0.9rem">Upload file Excel ch·ª©a c·ªôt "M√£ SP" v√† "T√™n H√†ng H√≥a". H·ªá th·ªëng s·∫Ω d√πng ƒë·ªÉ g·ª£i √Ω v√† t·ª± ƒëi·ªÅn m√£.</p>
                <input type="file" id="master-file" accept=".xlsx, .xls">
                <div id="master-status" style="font-size:0.9rem; margin-top:5px; color:#059669"></div>
            </div>

            <div class="grid-layout">
                <div class="card">
                    <div class="card-header">A. Nh·∫≠p Kho Th·ªß C√¥ng</div>
                    <label>T√™n H√†ng H√≥a (*)</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="imp-name" placeholder="G√µ t√™n thu·ªëc (b·ªè qua TH_)..." autocomplete="off">
                        <div id="imp-suggest" class="autocomplete-items"></div>
                    </div>

                    <div style="display:flex; gap:10px">
                        <div style="flex:1">
                            <label>M√£ SP (T·ª± ƒë·ªông)</label>
                            <input type="text" id="imp-code" placeholder="T·ª± load..." readonly style="background:#f1f5f9">
                        </div>
                        <div style="flex:1">
                            <label>ƒê∆°n V·ªã (*)</label>
                            <input type="text" id="imp-unit" placeholder="H·ªôp/Vi√™n...">
                        </div>
                    </div>

                    <div style="display:flex; gap:10px">
                        <div style="flex:1"><label>S·ªë L√¥ (*)</label><input type="text" id="imp-lot"></div>
                        <div style="flex:1"><label>H·∫°n D√πng (*)</label><input type="date" id="imp-exp"></div>
                    </div>
                    
                    <div style="display:flex; gap:10px">
                        <div style="flex:1"><label>S·ªë L∆∞·ª£ng (*)</label><input type="number" id="imp-qty"></div>
                        <div style="flex:1"><label>Ng√†y Nh·∫≠p</label><input type="date" id="imp-date"></div>
                    </div>
                    
                    <button class="btn btn-success" style="width:100%" onclick="saveManual()">L∆ØU NH·∫¨P KHO</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        B. Nh·∫≠p H√†ng Lo·∫°t
                        <div style="float:right">
                            <button class="btn btn-primary" style="padding:4px 8px; font-size:0.8rem" onclick="toggleMode('paste')">Paste</button>
                            <button class="btn btn-warning" style="padding:4px 8px; font-size:0.8rem" onclick="toggleMode('file')">Excel</button>
                        </div>
                    </div>

                    <div id="mode-paste">
                        <p style="font-size:0.85rem; color:#64748b; margin-bottom:5px">
                            Copy t·ª´ Excel (Kh√¥ng l·∫•y ti√™u ƒë·ªÅ):<br>
                            <b>STT | T√™n H√†ng H√≥a | ƒê∆°n V·ªã | S·ªë L√¥ | H·∫°n D√πng | S·ªë L∆∞·ª£ng</b>
                        </p>
                        <textarea id="paste-area" class="paste-area" placeholder="Click v√†o ƒë√¢y v√† ·∫•n Ctrl+V..."></textarea>
                        <button class="btn btn-primary" style="width:100%; margin-top:5px" onclick="processPaste()">Soi Chi·∫øu D·ªØ Li·ªáu</button>
                    </div>

                    <div id="mode-file" style="display:none">
                        <p style="font-size:0.85rem">File Excel c·ªôt: STT, T√™n, ƒê∆°n V·ªã, L√¥, H·∫°n, SL</p>
                        <input type="file" id="import-file" accept=".xlsx, .xls">
                    </div>

                    <div id="preview-box" style="display:none; margin-top:15px">
                        <div style="background:#ecfdf5; padding:5px; font-size:0.9rem; color:#065f46; margin-bottom:5px">
                            <strong>Ki·ªÉm tra:</strong> M√£ SP t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ t√™n.
                        </div>
                        <div style="overflow-y:auto; max-height:250px">
                            <table class="preview-table">
                                <thead><tr><th>M√£ SP</th><th>T√™n</th><th>ƒê∆°n V·ªã</th><th>L√¥</th><th>H·∫°n</th><th>SL</th><th>X√≥a</th></tr></thead>
                                <tbody id="preview-body"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" style="width:100%; margin-top:10px" onclick="syncData()">ƒê·ªíNG B·ªò V√ÄO KHO</button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px; height:auto">
                <div class="card-header">
                    Danh S√°ch T·ªìn Kho
                    <button class="btn btn-danger" style="float:right; font-size:0.8rem; padding:4px 10px" onclick="deleteAll()">X√≥a T·∫•t C·∫£</button>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px">
                    <input type="text" id="search-stock" placeholder="T√¨m ki·∫øm t√™n, m√£, l√¥..." style="flex:2">
                    <input type="date" id="filter-date" style="flex:1">
                    <select id="sort-stock" style="flex:1">
                        <option value="newest">M·ªõi nh·∫≠p</option>
                        <option value="exp">H·∫°n d√πng</option>
                    </select>
                </div>
                <div style="overflow-x:auto">
                    <table id="stock-table">
                        <thead>
                            <tr>
                                <th style="width:40px">STT</th>
                                <th>M√£ SP</th>
                                <th>T√™n H√†ng H√≥a</th>
                                <th>ƒê∆°n V·ªã</th>
                                <th>S·ªë L√¥</th>
                                <th>H·∫°n D√πng</th>
                                <th>S·ªë L∆∞·ª£ng</th>
                                <th style="width:110px">Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="stock-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <div class="grid-layout">
                <div class="card">
                    <div class="card-header">Phi·∫øu Xu·∫•t Kho (FEFO)</div>
                    <label>T√¨m thu·ªëc c·∫ßn xu·∫•t:</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="exp-name" placeholder="G√µ t√™n thu·ªëc..." autocomplete="off">
                        <div id="exp-suggest" class="autocomplete-items"></div>
                    </div>
                    
                    <div id="lot-list" style="margin-top:10px; min-height:50px"></div>
                    
                    <div style="border-top:1px dashed #cbd5e1; margin-top:15px; padding-top:10px">
                        <div style="display:flex; gap:10px">
                            <div style="flex:1"><label>S·ªë L∆∞·ª£ng Xu·∫•t</label><input type="number" id="exp-qty" disabled></div>
                            <div style="flex:1"><label>ƒê∆°n V·ªã</label><input type="text" id="exp-unit" readonly style="background:#f1f5f9"></div>
                        </div>
                        <label>N∆°i Nh·∫≠n</label><input type="text" id="exp-dest">
                        <label>Ng√†y Xu·∫•t</label><input type="date" id="exp-date">
                        <button class="btn btn-warning" id="btn-export" style="width:100%" disabled onclick="confirmExport()">X√ÅC NH·∫¨N XU·∫§T</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">L·ªãch S·ª≠ Xu·∫•t Kho</div>
                    <button class="btn btn-success" style="font-size:0.8rem; margin-bottom:10px" onclick="exportHistoryExcel()">Xu·∫•t Excel Phi·∫øu</button>
                    <div id="export-list" style="overflow-y:auto; max-height:450px"></div>
                </div>
            </div>

            <div class="card" style="margin-top:20px; height:auto">
                <div class="card-header">B√°o C√°o T·ªïng H·ª£p</div>
                <div style="display:flex; gap:10px; align-items:flex-end">
                    <div style="flex:1"><label>T·ª´ ng√†y</label><input type="date" id="rpt-start"></div>
                    <div style="flex:1"><label>ƒê·∫øn ng√†y</label><input type="date" id="rpt-end"></div>
                    <div style="flex:2">
                        <label>L·ªçc t√™n thu·ªëc</label>
                        <input type="text" id="rpt-filter" placeholder="Nh·∫≠p t√™n thu·ªëc...">
                    </div>
                    <div style="padding-bottom:15px">
                        <button class="btn btn-primary" onclick="genReport()">Xem</button>
                        <button class="btn btn-success" onclick="exportReportExcel()">Excel</button>
                    </div>
                </div>
                <table id="rpt-table" style="margin-top:10px">
                    <thead><tr><th>T√™n H√†ng H√≥a</th><th>ƒê∆°n V·ªã</th><th>T·ªìn ƒê·∫ßu</th><th>Nh·∫≠p</th><th>Xu·∫•t</th><th>T·ªìn Cu·ªëi</th></tr></thead>
                    <tbody id="rpt-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3>S·ª≠a Th√¥ng Tin</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="edit-name" placeholder="T√™n">
            <input type="text" id="edit-code" placeholder="M√£">
            <input type="text" id="edit-unit" placeholder="ƒê∆°n v·ªã">
            <input type="text" id="edit-lot" placeholder="L√¥">
            <input type="date" id="edit-exp">
            <input type="number" id="edit-qty">
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="saveEdit()">L∆∞u</button>
                <button class="btn btn-danger" onclick="document.getElementById('edit-modal').style.display='none'">H·ªßy</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Th√¥ng b√°o</div>

    <script>
        // FIREBASE INIT
        const firebaseConfig = {
            apiKey: "AIzaSyB54vAqmLmkMPq-L0X69oRS2DdVxxtrLPc",
            authDomain: "quanlykho-5c64f.firebaseapp.com",
            projectId: "quanlykho-5c64f",
            storageBucket: "quanlykho-5c64f.firebasestorage.app",
            messagingSenderId: "106024120320",
            appId: "1:106024120320:web:ede1dae16cb6cccd42e8e5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const refs = {
            items: db.ref('pharmaceuticals'),
            master: db.ref('excelFiles'),
            exports: db.ref('exports')
        };

        // VARIABLES
        let stockData = [], exportData = [], masterData = [], previewData = [];
        let currentExportLot = null;

        // INIT DATE
        document.getElementById('imp-date').valueAsDate = new Date();
        document.getElementById('exp-date').valueAsDate = new Date();

        // 1. DATA LOADING
        refs.items.on('value', s => {
            const d = s.val();
            stockData = d ? Object.keys(d).map(k => ({id:k, ...d[k]})) : [];
            renderStock();
            // Auto learn new codes/units from stock if not in master
            stockData.forEach(item => {
                if(item.productName) {
                    const k = cleanStr(item.productName);
                    if(!masterData.find(m => m.searchKey === k)) {
                        masterData.push({ name: item.productName, code: item.productCode||'', searchKey: k });
                    }
                }
            });
        });

        refs.exports.on('value', s => {
            const d = s.val();
            exportData = d ? Object.keys(d).map(k => ({id:k, ...d[k]})) : [];
            renderExportHistory();
        });

        refs.master.on('value', s => {
            const d = s.val();
            const files = d ? Object.values(d) : [];
            processMasterFiles(files);
        });

        // 2. MASTER DATA & SMART SEARCH LOGIC (CORE FIX)
        function cleanStr(str) {
            if(!str) return '';
            // Remove TH_, TH , Thu·ªëc... to create search key
            return str.toLowerCase().replace(/^th_|th\s+|thu·ªëc\s+/g, '').trim();
        }

        function processMasterFiles(files) {
            const map = new Map();
            files.forEach(f => {
                if(f.data) f.data.forEach(r => {
                    const name = r['T√™n H√†ng H√≥a'] || r['T√™n thu·ªëc'] || r['T√™n'];
                    const code = r['M√£ SP'] || r['M√£'] || r['Code'];
                    if(name) {
                        const key = cleanStr(name);
                        // Save Code & Name mapping
                        map.set(key, { name: name, code: code || '', searchKey: key });
                    }
                });
            });
            masterData = Array.from(map.values());
            document.getElementById('master-status').innerText = `ƒê√£ t·∫£i ${masterData.length} s·∫£n ph·∫©m g·ªëc.`;
        }

        // 3. AUTOCOMPLETE INPUT
        const impName = document.getElementById('imp-name');
        const impList = document.getElementById('imp-suggest');

        impName.addEventListener('input', function() {
            const val = cleanStr(this.value);
            impList.innerHTML = '';
            if(!val) return;

            // Search by Clean Key OR Code
            const matches = masterData.filter(m => m.searchKey.includes(val) || (m.code && m.code.toLowerCase().includes(val))).slice(0, 10);
            
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `<strong>${m.name}</strong> <br> <small style="color:#64748b">M√£: ${m.code || '...'}</small>`;
                div.onclick = () => {
                    // FILL DATA AUTOMATICALLY
                    impName.value = m.name;
                    document.getElementById('imp-code').value = m.code || '';
                    impList.innerHTML = '';
                };
                impList.appendChild(div);
            });
        });
        document.addEventListener('click', e => { if(e.target !== impName) impList.innerHTML = ''; });

        // 4. IMPORT LOGIC
        window.saveManual = async () => {
            const item = {
                productName: document.getElementById('imp-name').value.trim(),
                productCode: document.getElementById('imp-code').value.trim(),
                unit: document.getElementById('imp-unit').value.trim(),
                lotNumber: document.getElementById('imp-lot').value.trim(),
                expiryDate: document.getElementById('imp-exp').value,
                quantity: parseInt(document.getElementById('imp-qty').value),
                importDate: document.getElementById('imp-date').value,
                createdAt: new Date().toISOString()
            };
            if(!item.productName || !item.unit || !item.lotNumber || !item.quantity) return showToast('Thi·∫øu th√¥ng tin!', 'error');
            
            await saveToInventory(item);
            showToast('ƒê√£ nh·∫≠p kho!', 'success');
            ['imp-name','imp-code','imp-unit','imp-lot','imp-qty'].forEach(id => document.getElementById(id).value='');
        };

        window.processPaste = () => {
            const txt = document.getElementById('paste-area').value;
            if(!txt) return;
            // STT | Name | Unit | Lot | Exp | Qty
            const rows = txt.trim().split('\n').map(r => r.split('\t'));
            const data = rows.map((c, i) => ({
                name: c[1], unit: c[2], lot: c[3], exp: parseDate(c[4]), qty: c[5]
            }));
            processBulk(data);
        };

        document.getElementById('import-file').addEventListener('change', e => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = evt => {
                const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const data = json.map(r => ({
                    name: r['T√™n H√†ng H√≥a']||r['T√™n'],
                    unit: r['ƒê∆°n V·ªã']||r['ƒê∆°n v·ªã'],
                    lot: r['S·ªë L√¥']||r['S·ªë l√¥'],
                    exp: parseDate(r['H·∫°n S·ª≠ D·ª•ng']||r['H·∫°n d√πng']),
                    qty: r['S·ªë L∆∞·ª£ng']||r['S·ªë l∆∞·ª£ng']
                }));
                processBulk(data);
            };
            r.readAsArrayBuffer(f);
        });

        function parseDate(v) {
            if(!v) return '';
            if(typeof v === 'number') return new Date((v - 25569)*86400000).toISOString().split('T')[0];
            if(v.includes('/')) { const p = v.split('/'); if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`; }
            return v;
        }

        function processBulk(data) {
            previewData = data.map((d, i) => {
                // Find Code from Master Data using Smart Search
                const found = masterData.find(m => m.searchKey === cleanStr(d.name));
                return {
                    id: i,
                    productName: d.name,
                    productCode: found ? found.code : '', // Auto load code
                    unit: d.unit,
                    lotNumber: d.lot,
                    expiryDate: d.exp,
                    quantity: d.qty
                };
            });
            renderPreview();
            document.getElementById('preview-box').style.display = 'block';
        }

        function renderPreview() {
            const tb = document.getElementById('preview-body'); tb.innerHTML = '';
            previewData.forEach((d, i) => {
                tb.innerHTML += `
                    <tr>
                        <td><input value="${d.productCode}" onchange="previewData[${i}].productCode=this.value"></td>
                        <td>${d.productName}</td>
                        <td>${d.unit||''}</td>
                        <td><input value="${d.lotNumber}" onchange="previewData[${i}].lotNumber=this.value"></td>
                        <td><input type="date" value="${d.expiryDate}" onchange="previewData[${i}].expiryDate=this.value"></td>
                        <td><input type="number" value="${d.quantity}" onchange="previewData[${i}].quantity=this.value" style="width:50px"></td>
                        <td><button class="btn btn-danger" style="padding:2px 6px" onclick="previewData.splice(${i},1);renderPreview()">X</button></td>
                    </tr>
                `;
            });
        }

        window.syncData = async () => {
            for(const d of previewData) {
                if(d.productName && d.quantity) {
                    await saveToInventory({
                        productName: d.productName, productCode: d.productCode, unit: d.unit,
                        lotNumber: d.lotNumber, expiryDate: d.expiryDate, quantity: parseInt(d.quantity),
                        importDate: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString()
                    });
                }
            }
            showToast('ƒê·ªìng b·ªô xong!', 'success');
            document.getElementById('preview-box').style.display = 'none';
        }

        async function saveToInventory(item) {
            const exist = stockData.find(s => 
                s.productName.toLowerCase() === item.productName.toLowerCase() &&
                s.lotNumber.toLowerCase() === item.lotNumber.toLowerCase() &&
                s.expiryDate === item.expiryDate
            );
            if(exist) {
                await refs.items.child(exist.id).update({
                    quantity: parseInt(exist.quantity) + parseInt(item.quantity),
                    unit: item.unit // Update unit if new
                });
            } else {
                await refs.items.push(item);
            }
        }

        // 5. STOCK TABLE & ACTIONS
        function renderStock() {
            const tb = document.getElementById('stock-body'); tb.innerHTML = '';
            const term = document.getElementById('search-stock').value.toLowerCase();
            const list = stockData.filter(d => (d.productName||'').toLowerCase().includes(term) || (d.lotNumber||'').includes(term))
                .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); // Default sort

            list.forEach((d, i) => {
                tb.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${d.productCode||''}</td>
                        <td><b>${d.productName}</b></td>
                        <td>${d.unit||''}</td>
                        <td>${d.lotNumber}</td>
                        <td>${d.expiryDate}</td>
                        <td style="font-weight:bold">${d.quantity}</td>
                        <td>
                            <button class="btn btn-warning" style="padding:4px 8px; font-size:0.8rem" onclick="editStock('${d.id}')">S·ª≠a</button>
                            <button class="btn btn-danger" style="padding:4px 8px; font-size:0.8rem" onclick="delStock('${d.id}')">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        }
        document.getElementById('search-stock').addEventListener('input', renderStock);

        window.editStock = (id) => {
            const d = stockData.find(x => x.id === id);
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = d.productName;
            document.getElementById('edit-code').value = d.productCode;
            document.getElementById('edit-unit').value = d.unit;
            document.getElementById('edit-lot').value = d.lotNumber;
            document.getElementById('edit-exp').value = d.expiryDate;
            document.getElementById('edit-qty').value = d.quantity;
            document.getElementById('edit-modal').style.display='flex';
        }

        window.saveEdit = async () => {
            const id = document.getElementById('edit-id').value;
            await refs.items.child(id).update({
                productName: document.getElementById('edit-name').value,
                productCode: document.getElementById('edit-code').value,
                unit: document.getElementById('edit-unit').value,
                lotNumber: document.getElementById('edit-lot').value,
                expiryDate: document.getElementById('edit-exp').value,
                quantity: parseInt(document.getElementById('edit-qty').value)
            });
            document.getElementById('edit-modal').style.display='none';
            showToast('ƒê√£ s·ª≠a', 'success');
        }

        window.delStock = (id) => { if(confirm('X√≥a?')) refs.items.child(id).remove(); }
        window.deleteAll = () => { if(prompt('M·∫≠t kh·∫©u x√≥a (ideco2025):') === 'ideco2025') refs.items.remove(); }

        // 6. EXPORT LOGIC
        const expInp = document.getElementById('exp-name');
        const expSugg = document.getElementById('exp-suggest');
        
        expInp.addEventListener('input', function() {
            const val = cleanStr(this.value);
            expSugg.innerHTML = '';
            if(!val) return;
            // Find in Stock (Qty > 0)
            const matches = stockData.filter(d => parseInt(d.quantity) > 0 && cleanStr(d.productName).includes(val));
            const names = [...new Set(matches.map(m => m.productName))];
            
            names.forEach(n => {
                const d = document.createElement('div');
                d.className = 'autocomplete-item';
                d.innerHTML = n;
                d.onclick = () => { loadLotsForExport(n); expSugg.innerHTML = ''; expInp.value = n; };
                expSugg.appendChild(d);
            });
        });

        function loadLotsForExport(name) {
            const lots = stockData.filter(d => d.productName === name && parseInt(d.quantity) > 0)
                .sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            
            const div = document.getElementById('lot-list'); div.innerHTML = '';
            lots.forEach((l, i) => {
                const el = document.createElement('div');
                el.style.border = i===0 ? '2px solid var(--success)' : '1px solid #e2e8f0';
                el.style.padding = '10px'; el.style.marginBottom = '5px'; el.style.cursor='pointer'; el.style.borderRadius='6px';
                el.innerHTML = `L√¥: <b>${l.lotNumber}</b> | H·∫°n: ${l.expiryDate} | SL: <b>${l.quantity}</b> ${i===0?'(∆Øu ti√™n)':''}`;
                el.onclick = () => {
                    currentExportLot = l;
                    document.getElementById('exp-qty').disabled = false;
                    document.getElementById('exp-qty').max = l.quantity;
                    document.getElementById('exp-unit').value = l.unit || '';
                    document.getElementById('btn-export').disabled = false;
                    // Highlight
                    Array.from(div.children).forEach(c=>c.style.background='white');
                    el.style.background='#ecfdf5';
                };
                div.appendChild(el);
            });
        }

        window.confirmExport = async () => {
            if(!currentExportLot) return;
            const qty = parseInt(document.getElementById('exp-qty').value);
            if(!qty || qty > currentExportLot.quantity) return showToast('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá', 'error');

            const item = {
                productName: currentExportLot.productName,
                productCode: currentExportLot.productCode,
                unit: currentExportLot.unit, // SAVE UNIT
                lotNumber: currentExportLot.lotNumber,
                expiryDate: currentExportLot.expiryDate,
                quantity: qty,
                destination: document.getElementById('exp-dest').value,
                exportDate: document.getElementById('exp-date').value,
                relatedId: currentExportLot.id
            };
            await refs.exports.push(item);
            await refs.items.child(currentExportLot.id).update({ quantity: parseInt(currentExportLot.quantity) - qty });
            
            showToast('Xu·∫•t th√†nh c√¥ng', 'success');
            document.getElementById('lot-list').innerHTML='';
            document.getElementById('exp-qty').value='';
            document.getElementById('exp-qty').disabled=true;
        }

        function renderExportHistory() {
            const div = document.getElementById('export-list'); div.innerHTML = '';
            exportData.sort((a,b)=>new Date(b.exportDate)-new Date(a.exportDate)).forEach(e => {
                div.innerHTML += `
                    <div style="border-bottom:1px solid #f1f5f9; padding:10px; display:flex; justify-content:space-between">
                        <div>
                            <b>${e.productName}</b> (${e.unit||''}) <br>
                            <small>L√¥: ${e.lotNumber} | SL: ${e.quantity} -> ${e.destination}</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteExport('${e.id}')">X</button>
                    </div>
                `;
            });
        }

        window.deleteExport = async (id) => {
            if(!confirm('H·ªßy phi·∫øu v√† ho√†n kho?')) return;
            const ex = exportData.find(x => x.id === id);
            const stock = stockData.find(s => s.id === ex.relatedId);
            if(stock) await refs.items.child(stock.id).update({ quantity: parseInt(stock.quantity) + parseInt(ex.quantity) });
            await refs.exports.child(id).remove();
            showToast('ƒê√£ h·ªßy', 'success');
        }

        // 7. REPORT & EXCEL
        window.genReport = () => {
            const start = new Date(document.getElementById('rpt-start').value || '2000-01-01');
            const end = new Date(document.getElementById('rpt-end').value || '2099-12-31');
            const filter = document.getElementById('rpt-filter').value.toLowerCase();
            
            const rpt = {};
            // Snapshot aggregation
            stockData.forEach(s => {
                if(filter && !s.productName.toLowerCase().includes(filter)) return;
                if(!rpt[s.productName]) rpt[s.productName] = { name:s.productName, unit:s.unit||'', in:0, out:0, end:0 };
                rpt[s.productName].end += parseInt(s.quantity);
                const d = new Date(s.createdAt);
                if(d>=start && d<=end) rpt[s.productName].in += parseInt(s.quantity); // Approx
            });
            exportData.forEach(e => {
                const d = new Date(e.exportDate);
                if(d>=start && d<=end) {
                    if(!rpt[e.productName]) rpt[e.productName] = { name:e.productName, unit:e.unit||'', in:0, out:0, end:0 };
                    rpt[e.productName].out += parseInt(e.quantity);
                }
            });

            const tb = document.getElementById('rpt-body'); tb.innerHTML = '';
            Object.values(rpt).forEach(r => {
                tb.innerHTML += `<tr><td>${r.name}</td><td>${r.unit}</td><td>-</td><td>${r.in}</td><td>${r.out}</td><td>${r.end}</td></tr>`;
            });
        }

        window.exportReportExcel = () => {
            const tb = document.getElementById('rpt-table');
            const wb = XLSX.utils.table_to_book(tb);
            XLSX.writeFile(wb, "BaoCaoXNT.xlsx");
        }

        window.exportHistoryExcel = () => {
            const data = exportData.map(e => ({
                'Ng√†y': e.exportDate, 'M√£ SP': e.productCode, 'T√™n': e.productName,
                'ƒê∆°n V·ªã': e.unit, 'S·ªë L√¥': e.lotNumber, 'H·∫°n': e.expiryDate, 'SL': e.quantity, 'N∆°i Nh·∫≠n': e.destination
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "PhieuXuat");
            XLSX.writeFile(wb, "LichSuXuat.xlsx");
        }

        // Master File Logic
        document.getElementById('master-file').addEventListener('change', e => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = evt => {
                const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                refs.master.push({ fileName: f.name, data: json });
                showToast('ƒê√£ t·∫£i danh m·ª•c', 'success');
            }
            r.readAsArrayBuffer(f);
        });

        // Utils
        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(d=>d.style.display='none');
            document.getElementById(id).style.display='block';
            document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
            el.classList.add('active');
        }
        window.toggleMode = (m) => {
            document.getElementById('mode-paste').style.display = m==='paste'?'block':'none';
            document.getElementById('mode-file').style.display = m==='file'?'block':'none';
        }
        window.showToast = (m,t) => {
            const el=document.getElementById('toast'); el.textContent=m; el.style.background=t==='error'?'#ef4444':'#1e293b';
            el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),3000);
        }
    </script>
</body>
</html>
