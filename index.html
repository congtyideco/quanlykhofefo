<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kho D∆∞·ª£c GDP - IDECO (Update Unit)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        /* --- CSS G·ªêC (GI·ªÆ NGUY√äN) --- */
        :root { --primary: #4361ee; --secondary: #3a0ca3; --success: #4cc9f0; --danger: #f72585; --warning: #fca311; --light: #f8f9fa; --dark: #212529; --gray: #6c757d; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: var(--dark); background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1280px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); overflow: hidden; }
        header { background: linear-gradient(to right, var(--primary), var(--secondary)); color: white; padding: 20px; text-align: center; position: relative; }
        h1 { font-size: 2.2rem; margin-bottom: 10px; }
        .subtitle { font-size: 1.1rem; opacity: 0.9; }
        .nav-tabs { display: flex; justify-content: center; background: #f0f0f0; padding: 10px 0; margin-bottom: 20px; }
        .nav-tab { padding: 10px 20px; cursor: pointer; background: #e0e0e0; margin: 0 5px; border-radius: 5px 5px 0 0; transition: background 0.3s; font-weight: bold; }
        .nav-tab.active { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        
        .btn { display: inline-block; padding: 10px 16px; margin: 6px 4px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); font-size: 0.9rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); }
        .btn-success { background: #10b981; } .btn-danger { background: #ef4444; } .btn-warning { background: #f59e0b; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }

        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: var(--dark); color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); transform: translateY(100px); opacity: 0; transition: all 0.4s; z-index: 2000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #10b981; } .toast.error { background: #ef4444; }

        /* Giao di·ªán list & item g·ªëc */
        .documents-list, .export-records-list { margin-top: 15px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        .document-item, .export-record-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .document-item:hover, .export-record-item:hover { background-color: #f0f5ff; }
        .document-item.expired .document-date { color: var(--danger); font-weight: bold; }
        .document-item.warning .document-date { color: var(--warning); font-weight: bold; }
        .empty-list { text-align: center; padding: 20px; color: var(--gray); font-style: italic; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .modal-buttons { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }

        /* --- CSS M·ªöI CHO PH·∫¶N NH·∫¨P KHO C·∫¢I TI·∫æN --- */
        .import-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; }
        @media (max-width: 900px) { .import-layout { grid-template-columns: 1fr; } }
        .card-box { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .section-title { font-size: 1.3rem; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f3f4f6; padding-bottom: 10px; font-weight: bold; }
        
        .autocomplete { position: relative; }
        .autocomplete-items { position: absolute; border: 1px solid #d4d4d4; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background-color: #fff; }
        .autocomplete-items div { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .autocomplete-items div:hover { background-color: #e9e9e9; }
        
        .paste-area { width: 100%; height: 100px; font-family: monospace; font-size: 12px; border: 2px dashed #ccc; background: #f9fafb; white-space: pre; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .preview-table th { background: #e5e7eb; }
        .preview-table input { width: 100%; border: 1px solid transparent; background: transparent; }
        .preview-table input:focus { border-color: var(--primary); background: white; }

        /* App Content Layout (G·ªëc) */
        .app-content { display: flex; flex-wrap: wrap; gap: 20px; }
        .camera-section, .list-section { flex: 1; min-width: 300px; background: var(--light); border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .lot-suggestion { background: white; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .lot-suggestion:hover { background: #f0f5ff; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>QU·∫¢N L√ù KHO D∆Ø·ª¢C GDP - IDECO</h1>
            <p class="subtitle">H·ªá th·ªëng Nh·∫≠p - Xu·∫•t - T·ªìn & FEFO</p>
            <button onclick="toggleMasterData()" class="btn btn-warning" style="position: absolute; right: 20px; top: 20px; font-size: 0.8rem;">
                 Qu·∫£n l√Ω D·ªØ li·ªáu G·ªëc
            </button>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="tab1">1. NH·∫¨P KHO & T·ªíN KHO</div>
            <div class="nav-tab" data-tab="tab2" id="tab2-btn">2. XU·∫§T KHO & B√ÅO C√ÅO</div>
        </div>

        <div id="tab1" class="tab-content active">
            
            <div id="master-data-section" style="display:none; background: #fffbeb; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #fcd34d;">
                <h3 style="color: #b45309; margin-bottom: 10px;">Qu·∫£n l√Ω Danh M·ª•c G·ªëc (Excel)</h3>
                <p style="font-size: 0.9rem;">D√πng ƒë·ªÉ g·ª£i √Ω M√£ SP khi nh·∫≠p t√™n. T·ª± ƒë·ªông b·ªè qua "TH_" khi t√¨m ki·∫øm.</p>
                <input type="file" id="master-file-upload" accept=".xlsx, .xls">
                <div id="master-file-list" style="margin-top: 5px;"></div>
            </div>

            <div class="import-layout">
                <div class="card-box">
                    <div class="section-title">A. Nh·∫≠p Kho Th·ªß C√¥ng</div>
                    <div class="autocomplete">
                        <label>T√™n H√†ng H√≥a (*)</label>
                        <input type="text" id="imp-name" placeholder="G√µ t√™n thu·ªëc (VD: Panadol)..." autocomplete="off">
                        <div id="imp-name-list" class="autocomplete-items"></div>
                    </div>
                    <label>M√£ S·∫£n Ph·∫©m (T·ª± ƒë·ªông)</label>
                    <input type="text" id="imp-code" placeholder="M√£ s·∫Ω t·ª± hi·ªán..." readonly style="background-color: #f3f4f6;">
                    
                    <div style="display: flex; gap: 10px;">
                        <div style="flex:1"><label>ƒê∆°n V·ªã</label><input type="text" id="imp-unit" placeholder="H·ªôp/Vi√™n..."></div>
                        <div style="flex:1"><label>S·ªë L√¥ (*)</label><input type="text" id="imp-lot"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <div style="flex:1"><label>H·∫°n D√πng (*)</label><input type="date" id="imp-expiry"></div>
                        <div style="flex:1"><label>S·ªë L∆∞·ª£ng (*)</label><input type="number" id="imp-qty" min="1"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <div style="flex:1"><label>Ng√†y Nh·∫≠p</label><input type="date" id="imp-date"></div>
                        <div style="flex:1"><label>M√£ Phi·∫øu</label><input type="text" id="imp-slip"></div>
                    </div>
                    
                    <button id="btn-manual-import" class="btn btn-success" style="width: 100%;">L∆ØU NH·∫¨P KHO</button>
                </div>

                <div class="card-box">
                    <div class="section-title">B. Nh·∫≠p H√†ng Lo·∫°t (Excel/Paste)</div>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-outline" onclick="showImportMode('paste')">üìã D√°n (Paste)</button>
                        <button class="btn btn-sm btn-outline" onclick="showImportMode('file')">üìÇ Upload File</button>
                    </div>

                    <div id="mode-paste">
                        <p style="font-size: 0.8rem; color: #666;">
                            Copy t·ª´ Excel (b·ªè ti√™u ƒë·ªÅ) c·ªôt:<br>
                            <b>STT | T√™n H√†ng H√≥a | ƒê∆°n V·ªã | S·ªë L√¥ | H·∫°n D√πng | S·ªë L∆∞·ª£ng</b>
                        </p>
                        <textarea id="paste-input" class="paste-area" placeholder="Click v√†o ƒë√¢y v√† ·∫•n Ctrl+V..."></textarea>
                        <button id="btn-process-paste" class="btn btn-primary" style="width: 100%; margin-top: 5px;">Soi Chi·∫øu</button>
                    </div>

                    <div id="mode-file" style="display: none;">
                        <p style="font-size: 0.8rem;">File Excel c·ªôt: STT, T√™n H√†ng H√≥a, ƒê∆°n V·ªã, S·ªë L√¥, H·∫°n D√πng, S·ªë L∆∞·ª£ng</p>
                        <input type="file" id="import-file-input" accept=".xlsx, .xls">
                    </div>

                    <div id="preview-section" style="display: none; margin-top: 15px;">
                        <div style="background: #ecfdf5; padding: 5px; font-size: 0.9rem; color: #065f46;">
                            <strong>Ki·ªÉm tra:</strong> C√≥ th·ªÉ s·ª≠a M√£/L√¥ tr·ª±c ti·∫øp.
                        </div>
                        <div style="max-height: 250px; overflow-y: auto;">
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        <th style="width:30px">STT</th>
                                        <th>M√£ SP</th>
                                        <th>T√™n</th>
                                        <th>ƒê∆°n V·ªã</th>
                                        <th>L√¥</th>
                                        <th>H·∫°n</th>
                                        <th style="width:50px">SL</th>
                                        <th>X√≥a</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-body"></tbody>
                            </table>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button id="btn-sync-data" class="btn btn-success" style="flex:1">ƒê·ªíNG B·ªò</button>
                            <button onclick="cancelImport()" class="btn btn-danger">H·ªßy</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="list-section" style="margin-top: 20px; width: 100%;">
                <h2 class="section-title">Danh S√°ch S·∫£n Ph·∫©m Trong Kho</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="search-input" placeholder="T√¨m ki·∫øm theo t√™n, s·ªë l√¥...">
                    <button id="search-btn" class="btn">üîç</button>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="date" id="filter-date">
                    <select id="sort-by">
                        <option value="newest">M·ªõi nh·∫•t</option>
                        <option value="oldest">C≈© nh·∫•t</option>
                        <option value="name">Theo t√™n</option>
                        <option value="expiry">H·∫°n d√πng</option>
                    </select>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <strong>Danh s√°ch chi ti·∫øt:</strong>
                    <button id="delete-all-btn" class="btn btn-danger">X√≥a t·∫•t c·∫£ d·ªØ li·ªáu</button>
                </div>
                <div class="documents-list" id="documents-list">
                    <div class="empty-list">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <div class="app-content">
                <div class="camera-section">
                    <h2 class="section-title">Phi·∫øu Xu·∫•t Kho (FEFO)</h2>
                    <div class="autocomplete">
                        <input type="text" id="export-product-name-input" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ xu·∫•t kho..." autocomplete="off">
                        <div class="autocomplete-items" id="export-product-autocomplete"></div>
                    </div>
                    <div id="lot-suggestions-container"></div>
                    <input type="number" id="export-quantity" placeholder="S·ªë l∆∞·ª£ng xu·∫•t" min="1" disabled>
                    <input type="text" id="export-destination" placeholder="Xu·∫•t cho... (T√πy ch·ªçn)">
                    <input type="date" id="export-date" placeholder="Ng√†y xu·∫•t">
                    <button id="confirm-export-btn" class="btn btn-success" disabled>X√°c nh·∫≠n Xu·∫•t Kho</button>

                    <div class="excel-export-section" style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top:0">üì§ Xu·∫•t Kho T·ª´ File Excel</h3>
                        <label for="export-excel-file" class="btn btn-primary" style="width:100%; margin:0 0 5px 0">Ch·ªçn File Excel Xu·∫•t Kho</label>
                        <input type="file" id="export-excel-file" accept=".xlsx, .xls" style="display: none;">
                        <div id="export-excel-file-name" style="text-align:center; font-size:0.9rem; color:#666;">Ch∆∞a ch·ªçn file</div>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button id="preview-export-btn" class="btn btn-warning" style="flex:1">Xem Tr∆∞·ªõc</button>
                            <button id="process-export-btn" class="btn btn-success" style="flex:1" disabled>X·ª≠ L√Ω</button>
                        </div>
                        <div id="export-preview-container" style="display:none; margin-top:10px;">
                            <div style="max-height: 200px; overflow-y: auto;">
                                <table class="preview-table"><tbody id="export-preview-body"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="list-section">
                    <h2 class="section-title">Danh S√°ch Phi·∫øu Xu·∫•t Kho</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="export-slip-btn" class="btn btn-success" style="flex: 1;">Xu·∫•t Excel DS</button>
                        <button id="refresh-export-form-btn" class="btn" style="flex: 1; background-color: #6c757d;">üîÑ L√†m m·ªõi</button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="export-record-search-input" placeholder="T√¨m phi·∫øu xu·∫•t...">
                    </div>
                    <div class="export-records-list" id="export-records-list">
                        <div class="empty-list">Ch∆∞a c√≥ phi·∫øu xu·∫•t kho n√†o.</div>
                    </div>
                </div>
            </div>

            <div class="app-content">
                <div class="list-section" style="flex-basis: 100%;">
                    <h2 class="section-title">B√°o C√°o Xu·∫•t Nh·∫≠p T·ªìn</h2>
                    <div class="export-filters">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="date" id="report-start-date" title="T·ª´ ng√†y">
                            <input type="date" id="report-end-date" title="ƒê·∫øn ng√†y">
                        </div>
                        <div class="autocomplete">
                           <input type="text" id="report-product-name" placeholder="G√µ ƒë·ªÉ t√¨m v√† l·ªçc t√™n thu·ªëc...">
                           <div class="autocomplete-items" id="report-product-autocomplete"></div>
                        </div>
                        <button id="generate-report-btn" class="btn btn-primary" style="width: 100%; margin-top: 10px;">T·∫°o B√°o C√°o</button>
                    </div>
                    <button id="export-report-excel-btn" class="btn btn-success" style="width: 100%; margin: 0 0 15px 0;">Xu·∫•t B√°o C√°o Excel</button>
                    <div class="documents-list" id="report-list">
                        <div class="empty-list">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-all-modal" class="modal">
        <div class="modal-content">
            <h3>X√°c nh·∫≠n x√≥a t·∫•t c·∫£</h3>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a <strong>TO√ÄN B·ªò</strong> d·ªØ li·ªáu kho?</p>
            <input type="password" id="delete-all-password" style="width:100%; padding:10px;" placeholder="Nh·∫≠p m·∫≠t kh·∫©u x√°c nh·∫≠n">
            <div class="modal-buttons">
                <button id="confirm-delete-all" class="btn btn-danger">X√≥a H·∫øt</button>
                <button id="cancel-delete-all" class="btn">H·ªßy</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Th√¥ng b√°o</div>

    <script>
        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyB54vAqmLmkMPq-L0X69oRS2DdVxxtrLPc",
            authDomain: "quanlykho-5c64f.firebaseapp.com",
            projectId: "quanlykho-5c64f",
            storageBucket: "quanlykho-5c64f.firebasestorage.app",
            messagingSenderId: "106024120320",
            appId: "1:106024120320:web:ede1dae16cb6cccd42e8e5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const documentsRef = db.ref('pharmaceuticals');
        const excelFilesRef = db.ref('excelFiles'); 
        const exportsRef = db.ref('exports');

        // --- GLOBAL VARS ---
        let allDocuments = []; 
        let allExports = [];   
        let masterData = [];   
        let previewData = []; 
        
        let currentExportLot = null;
        let currentExportSessionRecords = []; 
        let exportExcelData = [];

        // --- INIT ---
        document.getElementById('imp-date').valueAsDate = new Date();
        document.getElementById('export-date').valueAsDate = new Date();

        // LOAD DATA
        documentsRef.on('value', snap => {
            const data = snap.val();
            allDocuments = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
            updateDocumentsList(allDocuments); 
            updateMasterDataFromStock();
        });
        exportsRef.on('value', snap => {
            const data = snap.val();
            allExports = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
        });
        excelFilesRef.on('value', snap => {
            const data = snap.val();
            const files = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
            processMasterData(files);
            renderMasterFiles(files);
        });

        // --- 1. DANH S√ÅCH T·ªíN KHO & CH·ª®C NƒÇNG S·ª¨A/X√ìA (KH√îI PH·ª§C T·ª™ G·ªêC) ---
        function updateDocumentsList(documents) {
            const listContainer = document.getElementById('documents-list');
            if (documents.length === 0) { 
                listContainer.innerHTML = '<div class="empty-list">Kho tr·ªëng.</div>'; return; 
            }
            
            let filtered = [...documents];
            const term = document.getElementById('search-input').value.toLowerCase();
            if(term) filtered = filtered.filter(d => (d.productName||'').toLowerCase().includes(term) || (d.lotNumber||'').toLowerCase().includes(term));
            
            const dateFilter = document.getElementById('filter-date').value;
            if(dateFilter) filtered = filtered.filter(d => new Date(d.createdAt).toISOString().split('T')[0] === dateFilter);
            
            const sortVal = document.getElementById('sort-by').value;
            if(sortVal === 'newest') filtered.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
            else if(sortVal === 'oldest') filtered.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));
            else if(sortVal === 'name') filtered.sort((a,b)=>(a.productName||'').localeCompare(b.productName||''));
            else if(sortVal === 'expiry') filtered.sort((a,b)=>new Date(a.expiryDate)-new Date(b.expiryDate));

            listContainer.innerHTML = '';
            filtered.forEach(doc => {
                const el = document.createElement('div');
                el.className = 'document-item';
                el.id = `doc-${doc.id}`;
                
                const exp = new Date(doc.expiryDate);
                const diff = Math.ceil((exp - new Date()) / (86400000));
                if(diff<=0) el.classList.add('expired');
                else if(diff<=60) el.classList.add('warning');

                el.innerHTML = `
                    <div style="flex:1">
                        <div style="font-weight:bold; color:var(--primary)">${doc.productName} ${doc.unit ? `(${doc.unit})` : ''}</div>
                        <div style="font-size:0.85rem; color:#666">
                            L√¥: ${doc.lotNumber} | H·∫°n: ${new Date(doc.expiryDate).toLocaleDateString('vi-VN')} | 
                            SL: <b>${doc.quantity}</b>
                        </div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-warning btn-sm" onclick="enableEditMode('${doc.id}')" style="margin:0; padding:5px 10px;">S·ª≠a</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDocument('${doc.id}')" style="margin:0; padding:5px 10px;">X√≥a</button>
                    </div>
                `;
                listContainer.appendChild(el);
            });
        }

        // Listener l·ªçc
        document.getElementById('search-input').addEventListener('input', () => updateDocumentsList(allDocuments));
        document.getElementById('filter-date').addEventListener('change', () => updateDocumentsList(allDocuments));
        document.getElementById('sort-by').addEventListener('change', () => updateDocumentsList(allDocuments));

        // Edit
        window.enableEditMode = function(id) {
            const doc = allDocuments.find(d => d.id === id);
            const el = document.getElementById(`doc-${id}`);
            el.innerHTML = `
                <div style="flex:1">
                    <input id="edit-name-${id}" value="${doc.productName}" style="margin:2px 0; padding:5px;">
                    <div style="display:flex; gap:5px;">
                        <input id="edit-unit-${id}" value="${doc.unit||''}" placeholder="ƒê∆°n v·ªã" style="width:60px; padding:5px;">
                        <input id="edit-lot-${id}" value="${doc.lotNumber}" placeholder="L√¥" style="flex:1; padding:5px;">
                        <input type="date" id="edit-exp-${id}" value="${doc.expiryDate}" style="flex:1; padding:5px;">
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="edit-qty-${id}" value="${doc.quantity}" placeholder="SL" style="flex:1; padding:5px;">
                    </div>
                </div>
                <div>
                    <button class="btn btn-success btn-sm" onclick="saveChanges('${id}')" style="margin:0 0 5px 0; width:100%;">L∆∞u</button>
                    <button class="btn btn-sm" onclick="updateDocumentsList(allDocuments)" style="margin:0; width:100%;">H·ªßy</button>
                </div>
            `;
        }
        window.saveChanges = async function(id) {
            const updated = {
                productName: document.getElementById(`edit-name-${id}`).value,
                unit: document.getElementById(`edit-unit-${id}`).value,
                lotNumber: document.getElementById(`edit-lot-${id}`).value,
                expiryDate: document.getElementById(`edit-exp-${id}`).value,
                quantity: document.getElementById(`edit-qty-${id}`).value
            };
            if(!updated.productName || !updated.expiryDate) { showToast('Thi·∫øu th√¥ng tin!', 'error'); return; }
            await documentsRef.child(id).update(updated);
            showToast('ƒê√£ c·∫≠p nh·∫≠t!', 'success');
        }

        // Delete One
        window.deleteDocument = function(id) {
            if(confirm('X√≥a s·∫£n ph·∫©m n√†y?')) {
                const p = prompt('Nh·∫≠p m·∫≠t kh·∫©u x√≥a (ideco2025):');
                if(p === 'ideco2025') { documentsRef.child(id).remove(); showToast('ƒê√£ x√≥a!', 'success'); } 
                else { showToast('Sai m·∫≠t kh·∫©u', 'error'); }
            }
        }

        // Delete All
        document.getElementById('delete-all-btn').addEventListener('click', () => {
            document.getElementById('delete-all-modal').style.display = 'flex';
            document.getElementById('delete-all-password').value = '';
        });
        document.getElementById('cancel-delete-all').addEventListener('click', () => {
            document.getElementById('delete-all-modal').style.display = 'none';
        });
        document.getElementById('confirm-delete-all').addEventListener('click', async () => {
            const pass = document.getElementById('delete-all-password').value;
            if(pass === 'ideco2025') {
                if(confirm('C·∫¢NH B√ÅO: B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫°ch d·ªØ li·ªáu kho?')) {
                    await documentsRef.remove();
                    showToast('ƒê√£ x√≥a to√†n b·ªô kho!', 'success');
                    document.getElementById('delete-all-modal').style.display = 'none';
                }
            } else { showToast('M·∫≠t kh·∫©u sai!', 'error'); }
        });

        // --- 2. NH·∫¨P KHO TH√îNG MINH (ƒê√É C·∫¨P NH·∫¨T C·ªòT ƒê∆†N V·ªä) ---
        function cleanSearchStr(str) { return str ? str.toLowerCase().replace(/^th_|th\s+|thu·ªëc\s+/g, '').trim() : ''; }
        function processMasterData(files) {
            const map = new Map();
            files.forEach(f => {
                if(f.data) f.data.forEach(row => {
                    const name = row['T√™n h√†ng h√≥a'] || row['T√™n thu·ªëc'] || row['T√™n'];
                    const code = row['M√£'] || row['M√£ SP'] || row['Code'];
                    if(name) map.set(cleanSearchStr(name), { name, code: code || '' });
                });
            });
            masterData = Array.from(map.values()).map(i => ({...i, searchKey: cleanSearchStr(i.name)}));
        }
        function updateMasterDataFromStock() {
            allDocuments.forEach(d => {
                if(d.productName) {
                    const k = cleanSearchStr(d.productName);
                    if(!masterData.find(m => m.searchKey === k)) masterData.push({ name: d.productName, code: d.productCode || '', searchKey: k });
                }
            });
        }

        // Autocomplete
        const impName = document.getElementById('imp-name');
        const impList = document.getElementById('imp-name-list');
        impName.addEventListener('input', function() {
            const val = cleanSearchStr(this.value);
            impList.innerHTML = ''; if(!val) return;
            const matches = masterData.filter(m => m.searchKey.includes(val) || (m.code && m.code.toLowerCase().includes(val))).slice(0,10);
            matches.forEach(m => {
                const d = document.createElement('div');
                d.innerHTML = `<strong>${m.name}</strong> ${m.code ? `(${m.code})` : ''}`;
                d.onclick = () => { impName.value = m.name; document.getElementById('imp-code').value = m.code || ''; impList.innerHTML = ''; };
                impList.appendChild(d);
            });
        });
        document.addEventListener('click', e => { if(e.target !== impName) impList.innerHTML = ''; });

        // Nh·∫≠p L·∫ª (C√≥ th√™m Unit)
        document.getElementById('btn-manual-import').addEventListener('click', async () => {
            const item = {
                productName: document.getElementById('imp-name').value.trim(),
                productCode: document.getElementById('imp-code').value.trim(),
                unit: document.getElementById('imp-unit').value.trim(),
                lotNumber: document.getElementById('imp-lot').value.trim(),
                expiryDate: document.getElementById('imp-expiry').value,
                quantity: parseInt(document.getElementById('imp-qty').value),
                importDate: document.getElementById('imp-date').value,
                slipCode: document.getElementById('imp-slip').value.trim(),
                createdAt: new Date().toISOString()
            };
            if(!item.productName || !item.lotNumber || !item.expiryDate || !item.quantity) { showToast('Thi·∫øu th√¥ng tin (*)', 'error'); return; }
            await saveToInventory(item);
            showToast('Nh·∫≠p kho th√†nh c√¥ng!', 'success');
            // Reset
            document.getElementById('imp-name').value = ''; document.getElementById('imp-code').value = '';
            document.getElementById('imp-unit').value = ''; document.getElementById('imp-lot').value = ''; document.getElementById('imp-qty').value = '';
        });

        // Import Excel/Paste (C·∫≠p nh·∫≠t c·ªôt Unit)
        function parseDate(val) {
            if(!val) return '';
            if(typeof val === 'number') return new Date((val - (25567 + 2)) * 86400 * 1000).toISOString().split('T')[0];
            if(typeof val === 'string') {
                if(val.includes('/')) { const p = val.split('/'); if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`; }
                if(val.includes('-') && val.split('-')[0].length!==4) { const p = val.split('-'); return `${p[2]}-${p[1]}-${p[0]}`; }
            }
            return val;
        }
        document.getElementById('btn-process-paste').addEventListener('click', () => {
            const txt = document.getElementById('paste-input').value; if(!txt.trim()) return;
            // Map: STT | Name | Unit | Lot | Exp | Qty
            processImportData(txt.trim().split('\n').map((r, i) => { 
                const c = r.split('\t'); 
                return { stt: c[0], name: c[1], unit: c[2], lot: c[3], exp: c[4], qty: c[5] }; 
            }));
        });
        document.getElementById('import-file-input').addEventListener('change', (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (evt) => {
                const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                processImportData(data.map((r, i) => ({ 
                    stt: r['STT']||i+1, 
                    name: r['T√™n H√†ng H√≥a']||r['T√™n h√†ng h√≥a']||r['T√™n thu·ªëc'], 
                    unit: r['ƒê∆°n V·ªã']||r['ƒê∆°n v·ªã']||r['Don vi'], 
                    lot: r['S·ªë L√¥']||r['S·ªë l√¥'], 
                    exp: r['H·∫°n S·ª≠ D·ª•ng']||r['H·∫°n s·ª≠ d·ª•ng'], 
                    qty: r['S·ªë L∆∞·ª£ng']||r['S·ªë l∆∞·ª£ng'] 
                })));
            }; r.readAsArrayBuffer(f);
        });
        function processImportData(data) {
            previewData = data.map((r, i) => {
                const found = masterData.find(m => m.searchKey === cleanSearchStr(r.name));
                return { id: i, stt: r.stt, productName: r.name, productCode: found ? found.code : '', unit: r.unit, lotNumber: r.lot, expiryDate: parseDate(r.exp), quantity: r.qty };
            });
            renderPreviewTable(); document.getElementById('preview-section').style.display = 'block';
        }
        function renderPreviewTable() {
            const tb = document.getElementById('preview-body'); tb.innerHTML = '';
            previewData.forEach((d, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d.stt}</td>
                    <td><input value="${d.productCode}" onchange="previewData[${i}].productCode=this.value"></td>
                    <td>${d.productName}</td>
                    <td>${d.unit || ''}</td>
                    <td><input value="${d.lotNumber}" onchange="previewData[${i}].lotNumber=this.value"></td>
                    <td><input type="date" value="${d.expiryDate}" onchange="previewData[${i}].expiryDate=this.value"></td>
                    <td><input type="number" value="${d.quantity}" onchange="previewData[${i}].quantity=this.value" style="width:50px"></td>
                    <td><button onclick="previewData.splice(${i},1);renderPreviewTable()" style="color:red;border:none;background:none;cursor:pointer">X</button></td>`;
                tb.appendChild(tr);
            });
        }
        document.getElementById('btn-sync-data').addEventListener('click', async function() {
            this.disabled = true; this.innerText = 'ƒêang ƒë·ªìng b·ªô...';
            for(const d of previewData) {
                if(d.productName && d.quantity > 0) await saveToInventory({
                    productName: d.productName, productCode: d.productCode, unit: d.unit, 
                    lotNumber: d.lotNumber, expiryDate: d.expiryDate,
                    quantity: parseInt(d.quantity), importDate: new Date().toISOString().split('T')[0], 
                    slipCode: 'BULK', createdAt: new Date().toISOString()
                });
            }
            showToast('ƒê·ªìng b·ªô xong!', 'success'); document.getElementById('preview-section').style.display = 'none'; this.disabled = false; this.innerText = 'ƒê·ªíNG B·ªò';
        });

        async function saveToInventory(item) {
            const exist = allDocuments.find(d => d.productName.toLowerCase() === item.productName.toLowerCase() && d.lotNumber.toLowerCase() === item.lotNumber.toLowerCase() && d.expiryDate === item.expiryDate);
            if(exist) await documentsRef.child(exist.id).update({ quantity: parseInt(exist.quantity) + parseInt(item.quantity), updatedAt: new Date().toISOString() });
            else await documentsRef.push(item);
        }

        // --- 3. TAB 2: GI·ªÆ NGUY√äN LOGIC G·ªêC ---
        window.handleProductClick = function(name) {
            document.getElementById('tab2-btn').click();
            document.getElementById('export-product-name-input').value = name;
            showLotSuggestions(name);
        }
        
        const expInput = document.getElementById('export-product-name-input');
        const expList = document.getElementById('export-product-autocomplete');
        expInput.addEventListener('input', function() {
            const val = this.value.toLowerCase(); expList.innerHTML = '';
            document.getElementById('lot-suggestions-container').innerHTML = '';
            if(!val) return;
            [...new Set(allDocuments.map(d=>d.productName))].filter(n=>n.toLowerCase().includes(val)).forEach(n=>{
                const d = document.createElement('div'); d.innerHTML = n; d.onclick=()=>{handleProductClick(n);expList.innerHTML='';}; expList.appendChild(d);
            });
        });

        function showLotSuggestions(name) {
            const div = document.getElementById('lot-suggestions-container'); div.innerHTML = '';
            const lots = allDocuments.filter(d => d.productName === name && parseInt(d.quantity) > 0).sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            if(lots.length===0) { div.innerHTML='<div class="empty-list">H·∫øt h√†ng.</div>'; document.getElementById('export-quantity').disabled=true; return; }
            lots.forEach((l, i) => {
                const el = document.createElement('div'); el.className = 'lot-suggestion'; if(i===0) el.style.border='2px solid #10b981';
                el.innerHTML = `L√¥: <b>${l.lotNumber}</b> - H·∫°n: <span style="color:red">${new Date(l.expiryDate).toLocaleDateString('vi-VN')}</span> - T·ªìn: <b>${l.quantity}</b>`;
                el.onclick = () => {
                    currentExportLot = {...l};
                    const q = document.getElementById('export-quantity'); q.max=l.quantity; q.placeholder=`Max ${l.quantity}`; q.value=''; q.disabled=false; q.focus();
                    document.getElementById('confirm-export-btn').disabled=false;
                    document.querySelectorAll('.lot-suggestion').forEach(x=>x.style.backgroundColor='white'); el.style.backgroundColor='#ecfdf5';
                };
                div.appendChild(el);
            });
        }

        document.getElementById('confirm-export-btn').addEventListener('click', async function() {
            if(!currentExportLot) return;
            const qty = parseInt(document.getElementById('export-quantity').value);
            if(!qty || qty <= 0 || qty > parseInt(currentExportLot.quantity)) { showToast('S·ªë l∆∞·ª£ng sai', 'error'); return; }
            
            const exp = {
                productName: currentExportLot.productName, productCode: currentExportLot.productCode||'', lotNumber: currentExportLot.lotNumber,
                expiryDate: currentExportLot.expiryDate, quantity: qty, destination: document.getElementById('export-destination').value,
                exportDate: document.getElementById('export-date').value, relatedImportId: currentExportLot.id, exportedAt: new Date().toISOString()
            };
            const ref = await exportsRef.push(exp);
            await documentsRef.child(currentExportLot.id).update({ quantity: parseInt(currentExportLot.quantity) - qty });
            
            currentExportSessionRecords.push({ id: ref.key, ...exp });
            updateExportRecordsList(currentExportSessionRecords);
            showToast('Xu·∫•t kho OK!', 'success');
            document.getElementById('export-quantity').value = ''; document.getElementById('export-quantity').disabled=true; currentExportLot=null;
        });

        function updateExportRecordsList(records) {
            const div = document.getElementById('export-records-list');
            if(records.length===0) { div.innerHTML='<div class="empty-list">Ch∆∞a c√≥ phi·∫øu xu·∫•t.</div>'; return; }
            div.innerHTML = records.map(r => `
                <div class="export-record-item" id="exp-${r.id}">
                    <div><b>${r.productName}</b> (L√¥: ${r.lotNumber})<br>Xu·∫•t: ${r.quantity} | ƒê·∫øn: ${r.destination||'-'}</div>
                    <div style="display:flex; gap:5px">
                        <button class="btn btn-warning btn-sm" onclick="editExport('${r.id}')" style="margin:0">S·ª≠a</button>
                        <button class="btn btn-danger btn-sm" onclick="delExport('${r.id}')" style="margin:0">X√≥a</button>
                    </div>
                </div>`).join('');
        }
        
        window.editExport = function(id) {
            const r = currentExportSessionRecords.find(x=>x.id===id); if(!r) return;
            document.getElementById(`exp-${id}`).innerHTML = `
                <div style="flex:1"><b>${r.productName}</b><br>SL: <input id="eq-${id}" value="${r.quantity}" style="width:50px"> ƒê·∫øn: <input id="ed-${id}" value="${r.destination}"></div>
                <div><button class="btn btn-success btn-sm" onclick="saveExport('${id}')">L∆∞u</button></div>`;
        }
        window.saveExport = async function(id) {
            const nq = parseInt(document.getElementById(`eq-${id}`).value);
            const nd = document.getElementById(`ed-${id}`).value;
            const old = currentExportSessionRecords.find(x=>x.id===id);
            const diff = nq - parseInt(old.quantity);
            // Update
            await exportsRef.child(id).update({ quantity: nq, destination: nd });
            // Adjust stock
            const doc = allDocuments.find(d=>d.id===old.relatedImportId);
            if(doc) await documentsRef.child(doc.id).update({ quantity: parseInt(doc.quantity) - diff });
            
            old.quantity = nq; old.destination = nd; updateExportRecordsList(currentExportSessionRecords); showToast('ƒê√£ s·ª≠a!', 'success');
        }
        window.delExport = async function(id) {
            if(!confirm('X√≥a phi·∫øu n√†y v√† ho√†n kho?')) return;
            const old = currentExportSessionRecords.find(x=>x.id===id);
            const doc = allDocuments.find(d=>d.id===old.relatedImportId);
            if(doc) await documentsRef.child(doc.id).update({ quantity: parseInt(doc.quantity) + parseInt(old.quantity) });
            await exportsRef.child(id).remove();
            currentExportSessionRecords = currentExportSessionRecords.filter(x=>x.id!==id);
            updateExportRecordsList(currentExportSessionRecords); showToast('ƒê√£ x√≥a!', 'success');
        }
        document.getElementById('refresh-export-form-btn').addEventListener('click', ()=>{ currentExportSessionRecords=[]; updateExportRecordsList([]); });

        // Report
        document.getElementById('generate-report-btn').addEventListener('click', ()=>{
            const start=new Date(document.getElementById('report-start-date').value||'2000-01-01');
            const end=new Date(document.getElementById('report-end-date').value||'2099-12-31'); end.setHours(23,59,59);
            const filter=document.getElementById('report-product-name').value.toLowerCase();
            const div=document.getElementById('report-list'); div.innerHTML='';
            
            const report={};
            allDocuments.forEach(d=>{
                if(filter && !d.productName.toLowerCase().includes(filter)) return;
                if(!report[d.productName]) report[d.productName]=0;
                report[d.productName]+=parseInt(d.quantity);
            });
            Object.keys(report).forEach(name=>{
                div.innerHTML += `<div class="document-item" ondblclick="handleProductClick('${name}')" style="cursor:pointer"><div><b>${name}</b></div><div>T·ªìn: <b>${report[name]}</b></div></div>`;
            });
        });
        document.getElementById('report-product-name').addEventListener('input', function(){
            const v=this.value.toLowerCase(); const l=document.getElementById('report-product-autocomplete'); l.innerHTML=''; if(!v)return;
            [...new Set(allDocuments.map(d=>d.productName))].filter(n=>n.toLowerCase().includes(v)).forEach(n=>{
                const d=document.createElement('div'); d.innerHTML=n; d.onclick=()=>{this.value=n;l.innerHTML='';}; l.appendChild(d);
            });
        });

        // Utils
        window.toggleMasterData = () => { const el = document.getElementById('master-data-section'); el.style.display = el.style.display==='none'?'block':'none'; }
        document.getElementById('master-file-upload').addEventListener('change', e => {
            const f = e.target.files[0];
            const r = new FileReader(); r.onload = evt => {
                const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                excelFilesRef.push({ fileName: f.name, data });
                renderMasterFiles([{fileName: f.name}]); 
            }; r.readAsArrayBuffer(f);
        });
        function renderMasterFiles(files) { document.getElementById('master-file-list').innerHTML = files.map(f => `<div>üìÑ ${f.fileName}</div>`).join(''); }
        window.showImportMode = mode => { document.getElementById('mode-paste').style.display = mode === 'paste' ? 'block' : 'none'; document.getElementById('mode-file').style.display = mode === 'file' ? 'block' : 'none'; }
        window.cancelImport = () => { previewData = []; document.getElementById('preview-section').style.display = 'none'; }
        
        function showToast(msg, type='info') {
            const t = document.getElementById('toast'); t.className=`toast ${type} show`; t.innerText=msg;
            setTimeout(()=>t.classList.remove('show'), 3000);
        }
        
        // Excel Export (G·ªëc)
        document.getElementById('export-excel-file').addEventListener('change', (e) => { if(e.target.files.length) { document.getElementById('export-excel-file-name').innerText = e.target.files[0].name; document.getElementById('process-export-btn').disabled = false; } });
        document.getElementById('preview-export-btn').addEventListener('click', () => {
            const f = document.getElementById('export-excel-file').files[0]; if(!f) return showToast('Ch·ªçn file', 'error');
            const r = new FileReader(); r.onload = e => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); exportExcelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                document.getElementById('export-preview-body').innerHTML = exportExcelData.map(r=>`<tr><td>${r['M√£ SP']||''}</td><td>${r['T√™n H√†ng H√≥a']||r['T√™n s·∫£n ph·∫©m']}</td><td>${r['S·ªë l∆∞·ª£ng']||0}</td></tr>`).join('');
                document.getElementById('export-preview-container').style.display='block';
            }; r.readAsArrayBuffer(f);
        });
        document.getElementById('process-export-btn').addEventListener('click', async function() {
            this.disabled=true; this.innerText='ƒêang x·ª≠ l√Ω...';
            let c=0;
            for(const r of exportExcelData) {
                const n=r['T√™n H√†ng H√≥a']||r['T√™n s·∫£n ph·∫©m']; let q=parseInt(r['S·ªë l∆∞·ª£ng']||0);
                const lots=allDocuments.filter(d=>d.productName===n && parseInt(d.quantity)>0).sort((a,b)=>new Date(a.expiryDate)-new Date(b.expiryDate));
                for(const l of lots) {
                    if(q<=0) break; const t=Math.min(q, parseInt(l.quantity));
                    await exportsRef.push({productName:n, lotNumber:l.lotNumber, expiryDate:l.expiryDate, quantity:t, destination:'Excel Auto', exportDate:document.getElementById('export-date').value, relatedImportId:l.id, exportedAt:new Date().toISOString()});
                    await documentsRef.child(l.id).update({quantity:parseInt(l.quantity)-t}); q-=t; c++;
                }
            }
            showToast(`Xong ${c} phi·∫øu`, 'success'); this.disabled=false; this.innerText='X·ª≠ L√Ω';
        });

        // Tab Switch
        document.querySelectorAll('.nav-tab').forEach(t => {
            t.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
                t.classList.add('active'); document.getElementById(t.dataset.tab).classList.add('active');
            });
        });
    </script>
</body>
</html>
